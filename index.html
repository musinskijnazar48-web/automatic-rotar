<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script> 

    <style>
        /* =========================================== */
        /* üé® –°–¢–ò–õ–ò (CSS) - –£–ª—É—á—à–µ–Ω–Ω—ã–π, –±–æ–ª–µ–µ —á–∏—Å—Ç—ã–π —Å—Ç–∏–ª—å */
        /* =========================================== */
        :root {
            --bg-dark: #0f0f0f;
            --bg-container: #1a1a1a;
            --bg-sidebar: #222222;
            --color-primary: #0088cc; /* –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (Telegram Blue) */
            --color-secondary: #00aaff;
            --color-text: #f0f0f0;
            --color-input: #333333;
            --color-border: #444444;
            --color-danger: #ff5555;
            --color-online: #42b72a; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-dark); 
            color: var(--color-text); 
            padding: 0; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-size: 14px;
        }
        .app-container { 
            width: 95%; 
            max-width: 1000px; 
            height: 90vh; 
            min-height: 600px;
            background: var(--bg-container); 
            border-radius: 18px; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7); 
            display: flex; 
            overflow: hidden; 
        }

        button {
            transition: all 0.2s;
            cursor: pointer;
            border-radius: 8px;
            padding: 10px 15px;
            border: none;
            color: white;
            font-weight: bold;
        }
        button:hover { filter: brightness(1.1); }
        .contact-item:hover, .contact-item.active { background: #333333; }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #loginScreen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); display: flex; justify-content: center; 
            align-items: center; z-index: 100; 
        }
        #loginBox { 
            background: var(--bg-sidebar); 
            padding: 50px; 
            border-radius: 12px; 
            text-align: center; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        .login-btn-group button { 
            margin: 15px auto;
            width: 300px;
            font-size: 1.1em;
        }
        #googleSignInBtn { background: #4285F4; }
        #guestSignInBtn { background: #6a6a6a; }
        #usernameSetup input { background: var(--color-input); border: 1px solid var(--color-border); padding: 10px; margin-bottom: 10px; border-radius: 5px; width: 80%; }
        #usernameSetup button { background: var(--color-primary); }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar { 
            width: 30%; 
            min-width: 250px; 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--color-border); 
            display: flex; 
            flex-direction: column; 
        }
        #contactList { 
            flex-grow: 1; 
            overflow-y: auto; 
        }
        .contact-item { 
            padding: 15px; 
            border-bottom: 1px solid #333333; 
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .avatar {
            width: 45px; height: 45px; border-radius: 50%;
            background: var(--color-primary); 
            display: inline-flex; justify-content: center; align-items: center;
            color: white; font-size: 1.2em; font-weight: bold; margin-right: 10px;
        }
        .logout-btn { 
            padding: 15px; font-weight: bold; border-top: 1px solid var(--color-border); cursor: pointer;
            display: flex; align-items: center; gap: 10px;
        }
        .logout-btn:nth-child(2) { color: var(--color-danger); }

        .badge-icon { margin-left: 5px; font-size: 1.1em; vertical-align: middle; }
        
        /* –ß–ê–¢ */
        #chatWindow { width: 70%; display: flex; flex-direction: column; }
        .chat-header { 
            background: var(--bg-sidebar); border-bottom: 1px solid var(--color-border); padding: 15px 20px;
            display: flex; align-items: center;
        }
        #messageArea { 
            flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; 
        }
        .message { 
            padding: 10px 15px; border-radius: 15px; max-width: 75%; position: relative;
        }
        .msg-user { background: var(--color-primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-other { background: var(--color-input); color: var(--color-text); align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg-time { font-size: 0.7em; color: #aaa; margin-left: 10px; opacity: 0.7; }
        .chat-input { background: var(--bg-sidebar); border-top: 1px solid var(--color-border); padding: 10px 15px; display: flex; align-items: center; }
        .chat-input input[type="text"] { flex-grow: 1; padding: 10px; border: none; border-radius: 20px; background: var(--color-input); color: var(--color-text); margin: 0 8px; }
        .chat-input button { background: none; color: var(--color-secondary); font-size: 1.5em; width: 40px; height: 40px; }
        .chat-input button#sendTextBtn { background: var(--color-primary); color: white; font-size: 1.2em; }
        
        /* –§–ê–ô–õ–´ */
        .file-icon-wrapper { display: flex; align-items: center; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-top: 5px; text-decoration: none; color: inherit; }
        .file-icon-wrapper i { font-size: 1.8em; margin-right: 10px; color: var(--color-secondary); }
        .message img { max-width: 100%; max-height: 250px; border-radius: 8px; margin-top: 5px; display: block; }
        
        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        #profileModal, #badgeModal { 
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.7); z-index: 200; justify-content: center; align-items: center; 
        }
        #profileContent, #badgeModal > div { 
            background: var(--bg-container); padding: 30px; border-radius: 15px; width: 350px; text-align: center; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); position: relative;
        }
        #profileAvatarImg { border: 3px solid var(--color-primary); }
        #adminPanel { border: 1px dashed gold; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>
    
    <div id="loginScreen">
        <div id="loginBox">
            <h2><i class="fab fa-telegram-plane"></i> –ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞:</p>
            
            <div class="login-btn-group">
                <button id="googleSignInBtn" onclick="signInWithGoogle()"><i class="fab fa-google"></i> –†–∞–±–æ—á–∏–π (Google)</button>
                <button id="guestSignInBtn" onclick="signInAsGuest()"><i class="fas fa-user-secret"></i> –ì–æ—Å—Ç–µ–≤–æ–π (–ê–Ω–æ–Ω–∏–º–Ω–æ)</button>
            </div>
            
            <div id="usernameSetup" style="display:none;">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</p>
                <input type="text" id="usernameSetupInput" placeholder="@username (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞)">
                <button onclick="saveUsername()"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <div id="usernameError" style="color: var(--color-danger); margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <div class="app-container" id="chatApp" style="display:none;">
        
        <div id="sidebar">
            <div id="searchBox" style="padding: 15px; border-bottom: 1px solid var(--color-border);">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ @username..." oninput="searchUsers(this.value)">
            </div>
            <div id="contactList">
                <div class="contact-item" id="globalChatLink" onclick="startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç', this, 'group')">
                    <div class="avatar">G</div>
                    <div class="contact-item-info">
                        <div class="contact-item-name">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</div>
                        <div class="contact-item-username">@public</div>
                    </div>
                </div>
                <div class="contact-item" id="channelLink" onclick="startNewChat('tech_channel', '–ù–æ–≤–æ—Å—Ç–Ω–æ–π –ö–∞–Ω–∞–ª', this, 'channel')">
                    <div class="avatar" style="background: purple;"><i class="fas fa-bullhorn"></i></div>
                    <div class="contact-item-info">
                        <div class="contact-item-name">–ù–æ–≤–æ—Å—Ç–Ω–æ–π –ö–∞–Ω–∞–ª</div>
                        <div class="contact-item-username">@tech</div>
                    </div>
                </div>
            </div>
            
            <div class="logout-btn" onclick="openProfileModal()">
                <i class="fas fa-user-circle"></i> –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å (<span id="myUsernameDisplay"></span>)
            </div>
            <div class="logout-btn" style="color: var(--color-danger);" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
            </div>
        </div>

        <div id="chatWindow">
            <div class="chat-header" id="chatHeader">
                <i id="menuToggle" class="fas fa-bars" onclick="toggleSidebar()" style="display: none;"></i>
                <button id="startVoiceChatBtn" onclick="startVoiceChat()" title="–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç" style="background: none; color: var(--color-secondary); font-size: 1.1em; margin-left: 10px; padding: 0; display:none;">
                    <i class="fas fa-headset"></i>
                </button>
                <div style="display: flex; flex-direction: column; margin-left: 10px;">
                    <span id="chatHeaderTitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span> 
                    <div id="chatHeaderStatus" style="font-size: 0.8em; color: #aaa; height: 16px;">
                        –û—Ñ—Ñ–ª–∞–π–Ω
                    </div>
                </div>
            </div>
            
            <div id="voiceChatControls" style="display: none; padding: 10px; background: #3a3a3a; color: white; justify-content: space-between; align-items: center;">
                <span><i class="fas fa-volume-up" style="color: var(--color-primary);"></i> –ê–∫—Ç–∏–≤–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç...</span>
                <div>
                    <button onclick="toggleMute()" style="background: var(--color-input); color: white; padding: 8px;"><i id="muteIcon" class="fas fa-microphone"></i></button>
                    <button onclick="leaveVoiceChat()" style="background: var(--color-danger); color: white; padding: 8px;">–ü–æ–∫–∏–Ω—É—Ç—å</button>
                </div>
            </div>
            
            <div id="messageArea">
                <div class="message msg-other">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
            </div>
            
            <div id="channelReadOnlyOverlay" style="display: none; padding: 12px; text-align: center; background: #333333; color: #aaaaaa; border-radius: 15px; margin: 10px 15px;">
                <i class="fas fa-lock"></i> –¢–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è. –ü–∏—Å–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã.
            </div>
            
            <div class="chat-input" id="chatInputArea" style="display:none;">
                <button onclick="document.getElementById('fileInput').click()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª" style="width: auto;">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleKeyPress(event)">
                <button id="sendTextBtn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" style="width: auto;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div id="profileModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 200; justify-content: center; align-items: center;">
        <div id="profileContent">
            <i class="fas fa-times" onclick="closeProfileModal()" style="position: absolute; top: 15px; right: 15px; color: #fff; cursor: pointer;"></i>
            
            <h2>–í–∞—à –ü—Ä–æ—Ñ–∏–ª—å</h2>
            
            <div id="profileAvatarWrapper" style="position: relative; width: 100px; height: 100px; margin: 0 auto 20px;">
                <img id="profileAvatarImg" src="https://via.placeholder.com/100" alt="–ê–≤–∞—Ç–∞—Ä" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                <button onclick="document.getElementById('avatarFileInput').click()" style="position: absolute; bottom: 0; right: 0; background: var(--color-primary); width: 30px; height: 30px; border-radius: 50%;">
                    <i class="fas fa-camera"></i>
                </button>
                <input type="file" id="avatarFileInput" style="display: none;" accept="image/*" onchange="uploadAvatar(event)">
            </div>
            
            <div style="text-align: left; margin-top: 15px;">
                <p><strong>–ò–º—è:</strong> <span id="profileDisplayName"></span></p>
                <p><strong>@username:</strong> <span id="profileUsername"></span></p>
                <p><strong>UID:</strong> <span id="profileUID"></span></p>
                <p id="profilePremiumStatus"><strong>Premium:</strong> <span></span></p>
                
                <hr style="border-color: #333; margin: 15px 0;">
                <p><strong>–í–∞—à –ó–Ω–∞—á–æ–∫:</strong> 
                    <span id="currentBadge"></span>
                    <i class="fas fa-edit" onclick="openBadgeSelection()" style="cursor: pointer; margin-left: 10px;"></i>
                </p>
                
                <div id="adminPanel" style="display:none; margin-top: 20px; padding: 10px;">
                    <h4><i class="fas fa-crown" style="color: gold;"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Premium</h4>
                    <input type="text" id="targetUsernameInput" placeholder="@username –¥–ª—è Premium" style="width: 90%; padding: 8px; margin-bottom: 10px; background: var(--color-input); border: none; border-radius: 5px; color: white;">
                    <button onclick="togglePremiumStatus(true)" style="background: var(--color-primary); margin-right: 5px; padding: 5px 10px;">–í—ã–¥–∞—Ç—å</button>
                    <button onclick="togglePremiumStatus(false)" style="background: var(--color-danger); padding: 5px 10px;">–û—Ç–æ–±—Ä–∞—Ç—å</button>
                </div>

            </div>
            
            <button onclick="logout()" style="background: var(--color-danger); color: white; margin-top: 20px;">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            </button>
        </div>
    </div>
    
    <div id="badgeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 201; justify-content: center; align-items: center;">
        <div>
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ó–Ω–∞—á–æ–∫ (Premium)</h3>
            <p style="font-size: 0.9em; color: #aaa;">–ó–Ω–∞—á–æ–∫ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–æ–∑–ª–µ –≤–∞—à–µ–≥–æ –∏–º–µ–Ω–∏.</p>
            <div id="badgeSelectionArea" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px;">
                </div>
            <button onclick="closeBadgeSelection()" style="background: #333; margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // ===========================================
        // üîë –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–ê–®–ò –ö–õ–Æ–ß–ò)
        // ===========================================
        const firebaseConfig = {
          // –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–ò –ö–õ–Æ–ß–ò FIREBASE
          apiKey: "AIzaSyBFBZLS7W9uBqpNItQUeCSYJ2IRG7G5UiA", 
          authDomain: "chat-ca735.firebaseapp.com",
          databaseURL: "https://chat-ca735-default-rtdb.firebaseio.com",
          projectId: "chat-ca735",
          storageBucket: "chat-ca735.firebasestorage.app",
          messagingSenderId: "407446630782",
          appId: "1:407446630782:web:5d9b66c3e8ff051bebc32f",
          measurementId: "G-DJ4K3BB9ZE"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); 
        const rtdb = firebase.database(); 

        // ===========================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ===========================================
        let currentUser = null; 
        let myUsername = null; 
        let activeChatId = null; 
        let activeChatType = 'group'; // 'group' –∏–ª–∏ 'channel'
        let unsubscribeFromChat = null; 
        let isPremium = false; 
        let myBadge = null; 
        const PREMIUM_BADGES = ['‚≠ê', 'üëë', 'üöÄ', 'üíª', 'üí°', 'üî•'];
        const ADMIN_USERNAME = 'ghost'; 

        // ===========================================
        // üîê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
        // ===========================================

        function generateRandomUsername() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let username = 'guest_';
            for (let i = 0; i < 6; i++) {
                username += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return username;
        }

        function signInAsGuest() {
            const guestUid = `guest-${Date.now()}`;
            const guestUsername = generateRandomUsername();
            const guestUser = { uid: guestUid, displayName: '–ì–æ—Å—Ç—å', email: 'guest', isGuest: true };
            
            currentUser = guestUser;
            document.getElementById('googleSignInBtn').style.display = 'none';
            document.getElementById('guestSignInBtn').style.display = 'none';
            
            document.getElementById('usernameSetupInput').value = guestUsername;
            document.getElementById('usernameSetup').style.display = 'block';
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => { handleAuthSuccess(result.user); })
                .catch(error => { console.error("–û—à–∏–±–∫–∞ Google Auth:", error); showCustomAlert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message); });
        }

        function handleAuthSuccess(user) {
            currentUser = user;
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        myUsername = userData.username;
                        isPremium = userData.isPremium || false; 
                        myBadge = userData.badge || null; 
                        
                        if (myUsername) { initializeChatApp(); } else {
                            document.getElementById('googleSignInBtn').style.display = 'none';
                            document.getElementById('guestSignInBtn').style.display = 'none';
                            document.getElementById('usernameSetup').style.display = 'block';
                        }
                    } else {
                        document.getElementById('googleSignInBtn').style.display = 'none';
                        document.getElementById('guestSignInBtn').style.display = 'none';
                        document.getElementById('usernameSetup').style.display = 'block';
                    }
                })
                .catch(error => { console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error); });
        }
        
        function saveUsername() {
            const usernameInput = document.getElementById('usernameSetupInput');
            const errorDiv = document.getElementById('usernameError');
            let usernameValue = usernameInput.value.trim().toLowerCase().replace('@', '');
            
            if (!/^[a-z0-9_]{3,}$/.test(usernameValue)) {
                errorDiv.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –õ–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, "_", –æ—Ç 3 —Å–∏–º–≤–æ–ª–æ–≤.';
                return;
            }
            
            errorDiv.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...';

            db.collection('users').where('username', '==', usernameValue).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        const isAdmin = usernameValue === ADMIN_USERNAME;
                        const userData = {
                            uid: currentUser.uid,
                            username: usernameValue,
                            displayName: currentUser.displayName || '–ì–æ—Å—Ç—å',
                            email: currentUser.email || 'guest',
                            isPremium: isAdmin || (Math.random() > 0.8), // 20% —à–∞–Ω—Å Premium, –∏–ª–∏ –∞–¥–º–∏–Ω
                            badge: null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        if (!currentUser.isGuest) { return db.collection('users').doc(currentUser.uid).set(userData); } 
                        else {
                            myUsername = usernameValue;
                            isPremium = userData.isPremium;
                            return Promise.resolve();
                        }
                    } else {
                        throw new Error('–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.');
                    }
                })
                .then(() => {
                    myUsername = usernameValue;
                    errorDiv.textContent = '–£—Å–ø–µ—à–Ω–æ! –í—Ö–æ–¥...';
                    initializeChatApp();
                })
                .catch(error => { errorDiv.textContent = error.message; console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏:", error); });
        }
        
        function logout() {
             if (currentUser.isGuest) { window.location.reload(); } 
             else { auth.signOut().then(() => { window.location.reload(); }); }
        }

        auth.onAuthStateChanged(user => {
            if (user) { handleAuthSuccess(user); } 
            else if (!currentUser || !currentUser.isGuest) {
                document.getElementById('chatApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('usernameSetup').style.display = 'none';
                document.getElementById('googleSignInBtn').style.display = 'flex';
                document.getElementById('guestSignInBtn').style.display = 'flex';
            }
        });

        // ===========================================
        // üíª UI / –ù–ê–í–ò–ì–ê–¶–ò–Ø –ò –ü–†–û–§–ò–õ–¨
        // ===========================================
        
        function initializeChatApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            updateMyUsernameDisplay();
            // setupPresence(); // –û—Ç–∫–ª—é—á–µ–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å RTDB –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ
            const globalChatLink = document.getElementById('globalChatLink');
            startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç', globalChatLink, 'group'); 
        }

        function updateMyUsernameDisplay() {
            const badgeIcon = myBadge ? `<span class="badge-icon" title="–í–∞—à –∑–Ω–∞—á–æ–∫">${myBadge}</span>` : '';
            const premiumStar = isPremium ? '<i class="fas fa-star" style="color: gold;" title="Premium"></i>' : '';
            const guestTag = currentUser.isGuest ? '(–ì–æ—Å—Ç—å)' : '';
            
            const myUsernameDisplay = document.getElementById('myUsernameDisplay');
            myUsernameDisplay.innerHTML = `@${myUsername} ${premiumStar} ${badgeIcon} ${guestTag}`;
            
            if (myUsername === ADMIN_USERNAME) { document.getElementById('adminPanel').style.display = 'block'; } 
            else { document.getElementById('adminPanel').style.display = 'none'; }
        }
        
        function openProfileModal() {
            loadProfileData();
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }
        
        function loadProfileData() {
            if (!currentUser) return;

            document.getElementById('profileDisplayName').textContent = currentUser.displayName || myUsername || '–ì–æ—Å—Ç—å';
            document.getElementById('profileUsername').textContent = `@${myUsername || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`;
            document.getElementById('profileUID').textContent = currentUser.uid;
            
            const premiumStatusEl = document.getElementById('profilePremiumStatus').querySelector('span');
            if (isPremium) {
                premiumStatusEl.textContent = '–î–∞! ‚≠ê';
                premiumStatusEl.style.color = 'gold';
            } else {
                premiumStatusEl.textContent = '–ù–µ—Ç';
                premiumStatusEl.style.color = 'grey';
            }
            document.getElementById('currentBadge').textContent = myBadge || '–ù–µ—Ç';


            // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                const avatarUrl = doc.exists && doc.data().avatarUrl ? doc.data().avatarUrl : null;
                if (avatarUrl) {
                    document.getElementById('profileAvatarImg').src = avatarUrl;
                } else {
                    const initials = myUsername ? myUsername[0].toUpperCase() : 'U';
                    document.getElementById('profileAvatarImg').src = `https://via.placeholder.com/100/0088cc/FFFFFF?text=${initials}`;
                }
            }).catch(e => { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:", e); });
        }

        function uploadAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileRef = storage.ref().child(`avatars/${currentUser.uid}/${file.name}`);
            const uploadTask = fileRef.put(file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('chatHeaderStatus').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞: ${progress.toFixed(0)}%`;
                }, 
                (error) => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:", error);
                    showCustomAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞.");
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        db.collection('users').doc(currentUser.uid).update({ avatarUrl: downloadURL })
                        .then(() => {
                            document.getElementById('profileAvatarImg').src = downloadURL;
                            showCustomAlert("–ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                            document.getElementById('chatHeaderStatus').textContent = '–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω';
                        });
                    });
                }
            );
        }
        
        function startNewChat(targetUidOrTag, targetUsername, element = null, chatType = 'group') {
            document.getElementById('messageArea').innerHTML = '';
            
            if (unsubscribeFromChat) { unsubscribeFromChat(); }

            activeChatId = targetUidOrTag;
            activeChatType = chatType;
            
            const isChannelAdmin = (myUsername === ADMIN_USERNAME);
            const chatInputArea = document.getElementById('chatInputArea');
            const readOnlyOverlay = document.getElementById('channelReadOnlyOverlay');
            
            updateChatHeader(targetUsername, targetUidOrTag, chatType);
            
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è –ö–∞–Ω–∞–ª–æ–≤ (–¢–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)
            if (chatType === 'channel' && !isChannelAdmin) {
                chatInputArea.style.display = 'none';
                readOnlyOverlay.style.display = 'block';
            } else {
                chatInputArea.style.display = 'flex';
                readOnlyOverlay.style.display = 'none';
                document.getElementById('messageInput').focus();
            }

            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            if (element) { element.classList.add('active'); }
            
            listenToChatMessages(targetUidOrTag);
        }
        
        function updateChatHeader(targetUsername, targetUidOrTag, chatType) {
            const headerTitle = document.getElementById('chatHeaderTitle');
            const headerStatus = document.getElementById('chatHeaderStatus');
            const startVoiceChatBtn = document.getElementById('startVoiceChatBtn');
            
            headerTitle.innerHTML = `–ß–∞—Ç —Å @${targetUsername}`;
            
            const chatTypeIcon = chatType === 'channel' ? '<i class="fas fa-bullhorn" style="color: #ccc;"></i> –ö–∞–Ω–∞–ª' : '<i class="fas fa-users" style="color: #ccc;"></i> –ì—Ä—É–ø–ø–∞';
            
            headerStatus.innerHTML = chatTypeIcon; 
            
            startVoiceChatBtn.style.display = chatType === 'group' ? 'inline' : 'none';
        }

        // ===========================================
        // ‚ú® –°–¢–ò–ö–ï–†–´/–ó–ù–ê–ß–ö–ò –ü–†–û–§–ò–õ–Ø
        // ===========================================
        
        function openBadgeSelection() {
            if (!isPremium) {
                showCustomAlert("–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Premium-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.");
                return;
            }
            
            const area = document.getElementById('badgeSelectionArea');
            area.innerHTML = '';
            
            area.innerHTML += `<button onclick="selectBadge(null)" style="background: var(--color-input); color: white; border: 1px dashed #666; padding: 10px;">(–ë–µ–∑ –∑–Ω–∞—á–∫–∞)</button>`;

            PREMIUM_BADGES.forEach(badge => {
                area.innerHTML += `<button onclick="selectBadge('${badge}')" style="font-size: 2em; padding: 10px; background: #3a3a3a; border: none; border-radius: 8px;">${badge}</button>`;
            });
            
            document.getElementById('badgeModal').style.display = 'flex';
        }

        function closeBadgeSelection() {
            document.getElementById('badgeModal').style.display = 'none';
        }

        function selectBadge(badge) {
            const newBadge = badge === 'null' ? null : badge;
            
            db.collection('users').doc(currentUser.uid).update({ badge: newBadge })
            .then(() => {
                myBadge = newBadge;
                updateMyUsernameDisplay();
                document.getElementById('currentBadge').textContent = newBadge || '–ù–µ—Ç';
                closeBadgeSelection();
                showCustomAlert("–í–∞—à –∑–Ω–∞—á–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω!");
            })
            .catch(e => { console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–∫–∞:", e); showCustomAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–∫–∞."); });
        }
        
        // ===========================================
        // ‚≠ê –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–ï PREMIUM (–¥–ª—è @Ghost)
        // ===========================================

        function togglePremiumStatus(status) {
            if (myUsername !== ADMIN_USERNAME) {
                showCustomAlert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –≤—ã–¥–∞—á–∏ Premium.");
                return;
            }

            const targetUsername = document.getElementById('targetUsernameInput').value.trim().replace('@', '');
            if (!targetUsername) {
                showCustomAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
                return;
            }

            db.collection('users').where('username', '==', targetUsername).get()
                .then(snapshot => {
                    if (snapshot.empty) { showCustomAlert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @${targetUsername} –Ω–µ –Ω–∞–π–¥–µ–Ω.`); return; }
                    
                    const userDoc = snapshot.docs[0];
                    return db.collection('users').doc(userDoc.id).update({
                        isPremium: status
                    }).then(() => {
                        showCustomAlert(`–°—Ç–∞—Ç—É—Å Premium –¥–ª—è @${targetUsername}: ${status ? '–í–´–î–ê–ù' : '–û–¢–û–ë–†–ê–ù'}.`);
                    });
                })
                .catch(error => { console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ Premium:", error); showCustomAlert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."); });
        }


        // ===========================================
        // üí¨ –ß–ê–¢: –û–¢–ü–†–ê–í–ö–ê –ò –ü–†–û–°–õ–£–®–ö–ê
        // ===========================================

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'fas fa-image';
            if (mimeType.startsWith('audio/')) return 'fas fa-music';
            if (mimeType.startsWith('video/')) return 'fas fa-video';
            if (mimeType.includes('pdf')) return 'fas fa-file-pdf';
            return 'fas fa-file';
        }
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        function createMessageElement(text, time, isUser, fileUrl = null, fileName = null, fileType = null, fileSize = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isUser ? 'msg-user' : 'msg-other');
            
            if (fileUrl) {
                if (fileType && fileType.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = fileUrl;
                    messageDiv.appendChild(img);
                } else if (fileType && fileType.startsWith('audio/')) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = fileUrl;
                    messageDiv.appendChild(audio);
                } else {
                    const fileWrapper = document.createElement('a');
                    fileWrapper.href = fileUrl;
                    fileWrapper.target = '_blank';
                    fileWrapper.className = 'file-icon-wrapper';
                    fileWrapper.innerHTML = `<i class="${getFileIcon(fileType)}"></i><div class="file-info"><span class="file-name">${fileName}</span><span class="file-size">${formatBytes(fileSize || 0)}</span></div>`;
                    messageDiv.appendChild(fileWrapper);
                }
                
                if (text) { messageDiv.innerHTML += '<br>' + text; }
            } else {
                 messageDiv.innerHTML = text;
            }

            const timeSpan = document.createElement('span');
            timeSpan.className = 'msg-time';
            timeSpan.textContent = time;
            messageDiv.appendChild(timeSpan);
            
            return messageDiv;
        }

        function listenToChatMessages(chatId) {
            const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp');
            
            unsubscribeFromChat = messagesRef.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const msg = change.doc.data();
                        const messageArea = document.getElementById('messageArea');
                        const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '—Å–µ–π—á–∞—Å';
                        
                        const msgElement = createMessageElement(
                            msg.text, time, msg.senderId === currentUser.uid, 
                            msg.fileUrl, msg.fileName, msg.fileType, msg.fileSize
                        );
                        
                        messageArea.appendChild(msgElement);
                        messageArea.scrollTop = messageArea.scrollHeight;
                    }
                });
            }, error => { console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —á–∞—Ç–∞:", error); });
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !activeChatId) return;
            if (activeChatType === 'channel' && myUsername !== ADMIN_USERNAME) {
                 showCustomAlert("–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª—ã –≤ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª.");
                 return;
             }

            const fileRef = storage.ref().child(`chats/${activeChatId}/${Date.now()}_${file.name}`);
            const uploadTask = fileRef.put(file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('chatHeaderStatus').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${progress.toFixed(0)}%`;
                }, 
                (error) => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", error);
                    showCustomAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.");
                    document.getElementById('chatHeaderStatus').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        const messageText = document.getElementById('messageInput').value.trim();
                        sendMessageToDB(messageText, downloadURL, file.name, file.type, file.size);
                        document.getElementById('messageInput').value = ''; 
                        event.target.value = '';
                        document.getElementById('chatHeaderStatus').textContent = '–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
                    });
                }
            );
        }

        function sendMessageToDB(text, fileUrl = null, fileName = null, fileType = null, fileSize = null) {
             if (!currentUser || !activeChatId) return;
             if (activeChatType === 'channel' && myUsername !== ADMIN_USERNAME) { showCustomAlert("–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ."); return; }
             
             const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>');
             
             const messageData = {
                 senderId: currentUser.uid, senderUsername: myUsername, text: formattedText,
                 timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                 fileUrl: fileUrl, fileName: fileName, fileType: fileType, fileSize: fileSize
             };

             db.collection('chats').doc(activeChatId).collection('messages').add(messageData)
                 .catch((error) => { console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error); });
        }
        
        function sendMessage() {
            const text = document.getElementById('messageInput').value.trim();
            if (text === '') return;
            sendMessageToDB(text);
            document.getElementById('messageInput').value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') { sendMessage(); }
        }
        
        // ===========================================
        // üéôÔ∏è –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ (–ó–∞–≥–ª—É—à–∫–∏)
        // ===========================================
        function startVoiceChat() { showCustomAlert("–ó–∞–ø—É—Å–∫ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞ (–¢—Ä–µ–±—É–µ—Ç—Å—è WebRTC)! üìû"); }
        function toggleMute() { showCustomAlert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ."); }
        function leaveVoiceChat() { showCustomAlert("–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç. üëã"); }
        
        // ===========================================
        // ‚ö†Ô∏è –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
        // ===========================================
        function showCustomAlert(message) { alert(message); }
        
    </script>
</body>
</html>
