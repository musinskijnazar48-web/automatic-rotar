<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä: Telegram Style (v2)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script> 

    <style>
        /* =========================================== */
        /* üé® –°–¢–ò–õ–ò (CSS) */
        /* =========================================== */
        :root {
            --bg-dark: #0f0f0f;
            --bg-container: #1a1a1a;
            --bg-sidebar: #222222;
            --color-primary: #0088cc; 
            --color-secondary: #00aaff;
            --color-text: #f0f0f0;
            --color-input: #333333;
            --color-border: #444444;
            --color-danger: #ff5555;
            
            --color-online: #42b72a; 
            --color-gradient-start: #0093E9;
            --color-gradient-end: #80D0C4;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-dark); 
            color: var(--color-text); 
            padding: 0; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-size: 14px;
        }
        .app-container { 
            width: 95%; 
            max-width: 1000px; 
            height: 90vh; 
            min-height: 600px;
            background: var(--bg-container); 
            border-radius: 18px; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7); 
            display: flex; 
            overflow: hidden; 
        }

        button, .contact-item, .message { transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        .message:hover { transform: scale(1.01); }

        @keyframes typing-dot {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin: 0 1px;
            background-color: var(--color-secondary);
            border-radius: 50%;
            animation: typing-dot 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #loginScreen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); display: flex; justify-content: center; 
            align-items: center; z-index: 100; 
        }
        #loginBox { 
            background: var(--bg-sidebar); 
            padding: 50px; 
            border-radius: 12px; 
            text-align: center; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        .login-btn-group button { 
            padding: 15px 30px; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 1.2em;
            display: flex;
            align-items: center;
            margin: 15px auto;
            width: 300px;
            justify-content: center;
        }
        #googleSignInBtn { 
            background: #4285F4; /* Google Blue */
        }
        #guestSignInBtn { 
            background: #6a6a6a; /* Gray for Guest */
        }
        .login-btn-group button i { margin-right: 10px; }
        #usernameSetup input { background: var(--color-input); border-color: var(--color-border); }
        #usernameSetup button { background: var(--color-primary); }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar { 
            width: 30%; 
            min-width: 250px; 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--color-border); 
            display: flex; 
            flex-direction: column; 
        }
        #searchBox { padding: 15px; border-bottom: 1px solid var(--color-border); }
        #searchBox input { 
            background: var(--color-input); 
            color: var(--color-text); 
            border: none; 
            padding: 10px; 
            border-radius: 20px; 
            width: 100%; 
        }
        .contact-item { 
            padding: 15px; 
            border-bottom: 1px solid #333333; 
            display: flex;
            align-items: center;
        }
        .contact-item:hover, .contact-item.active { background: #333333; }
        .contact-item-name { color: white; }
        .contact-item-username { color: #aaaaaa; font-size: 0.85em; }
        .contact-item-info { flex-grow: 1; }
        .logout-btn { 
            padding: 15px;
            color: var(--color-danger); 
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 85, 85, 0.3);
            border-top: 1px solid var(--color-border);
            cursor: pointer;
        }

        /* –ê–≤–∞—Ç–∞—Ä –∏ —Å—Ç–∞—Ç—É—Å */
        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-gradient-start), var(--color-gradient-end));
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            margin-right: 10px;
        }
        .contact-avatar-wrapper {
            position: relative;
        }
        .online-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--color-border); 
            border: 2px solid var(--bg-sidebar);
            position: absolute;
            bottom: 0;
            right: 0;
        }
        .online .online-status-dot {
            background-color: var(--color-online); 
            box-shadow: 0 0 5px var(--color-online);
        }

        /* –û–ö–ù–û –ß–ê–¢–ê */
        #chatWindow { width: 70%; display: flex; flex-direction: column; }
        .chat-header { 
            padding: 15px 20px; 
            background: var(--bg-sidebar); 
            border-bottom: 1px solid var(--color-border); 
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }
        #chatHeaderTitle {
            font-weight: bold;
            font-size: 1.1em;
        }
        #messageArea { 
            flex-grow: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message { 
            padding: 12px 18px; 
            border-radius: 20px; 
            max-width: 75%; 
            line-height: 1.5; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .msg-user { 
            background: var(--color-primary); 
            color: white; 
            align-self: flex-end; 
            border-bottom-right-radius: 4px; 
        }
        .msg-other { 
            background: var(--color-input); 
            color: var(--color-text); 
            align-self: flex-start; 
            border-bottom-left-radius: 4px; 
        }
        .file-icon-wrapper {
            display: flex;
            align-items: center;
            margin-top: 5px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            cursor: pointer;
        }
        .file-icon-wrapper i {
            font-size: 2em;
            margin-right: 10px;
            color: var(--color-secondary);
        }
        .file-info {
            display: flex;
            flex-direction: column;
            text-align: left;
        }
        .file-name {
            font-weight: bold;
            word-break: break-all;
        }
        .file-size {
            font-size: 0.8em;
            color: #aaa;
        }
        
        /* –ú–µ–¥–∏–∞ –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 5px;
            display: block;
        }
        .message audio {
            width: 100%;
            margin-top: 5px;
            height: 35px;
        }
        
        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .chat-input { 
            display: flex; 
            padding: 10px 15px; 
            background: var(--bg-sidebar); 
            border-top: 1px solid var(--color-border); 
            align-items: center;
        }
        .chat-input input[type="text"] { 
            flex-grow: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 25px; 
            background: var(--color-input); 
            color: var(--color-text); 
            margin: 0 8px; 
            font-size: 1em;
        }
        .chat-input button {
            background: none;
            border: none;
            color: var(--color-secondary);
            font-size: 1.5em;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            padding: 0;
            cursor: pointer;
        }
        .chat-input button#sendTextBtn {
            background: var(--color-primary);
            color: white;
            font-size: 1.2em;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å (–ú–æ–±–∏–ª—å–Ω—ã–π –≤–∏–¥) */
        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                min-height: 100vh;
                border-radius: 0;
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                min-width: 100%;
                height: 100%; 
                position: absolute; 
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease-out;
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #chatWindow {
                width: 100%;
            }
            #menuToggle { 
                display: block !important; 
                margin-right: 15px; 
                font-size: 1.5em;
                color: var(--color-secondary);
                cursor: pointer;
            }
        }
        #menuToggle { 
            display: none;
        }
    </style>
</head>
<body>
    
    <div id="loginScreen">
        <div id="loginBox">
            <h2><i class="fab fa-telegram-plane"></i> –ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞:</p>
            
            <div class="login-btn-group">
                <button id="googleSignInBtn" onclick="signInWithGoogle()"><i class="fab fa-google"></i> –†–∞–±–æ—á–∏–π (Google)</button>
                <button id="guestSignInBtn" onclick="signInAsGuest()"><i class="fas fa-user-secret"></i> –ì–æ—Å—Ç–µ–≤–æ–π (–ê–Ω–æ–Ω–∏–º–Ω–æ)</button>
            </div>
            
            <div id="usernameSetup" style="display:none;">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫ –≤ TG):</p>
                <input type="text" id="usernameSetupInput" placeholder="@username (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)">
                <button onclick="saveUsername()"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <div id="usernameError" style="color: var(--color-danger); margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <div class="app-container" id="chatApp" style="display:none;">
        
        <div id="sidebar">
            <div id="searchBox">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ @username..." oninput="searchUsers(this.value)">
            </div>
            <div id="contactList">
                <div class="contact-item" id="globalChatLink" onclick="startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç', this)">
                    <div class="contact-avatar-wrapper">
                        <div class="avatar">G</div>
                        <span class="online-status-dot"></span>
                    </div>
                    <div class="contact-item-info">
                        <div class="contact-item-name">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</div>
                        <div class="contact-item-username">@public</div>
                    </div>
                </div>
                </div>
             <div class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏ (<span id="myUsernameDisplay"></span>)
            </div>
        </div>

        <div id="chatWindow">
            <div class="chat-header" id="chatHeader">
                <i id="menuToggle" class="fas fa-bars" onclick="toggleSidebar()"></i>
                
                <button id="startVoiceChatBtn" onclick="startVoiceChat()" title="–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç" style="background: none; border: none; color: var(--color-secondary); font-size: 1.1em; margin-left: 10px; cursor: pointer; display:none;">
                    <i class="fas fa-headset"></i>
                </button>
                
                <div style="display: flex; flex-direction: column; margin-left: 10px;">
                    <span id="chatHeaderTitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span> 
                    <div id="chatHeaderStatus" style="font-size: 0.8em; color: #aaa; height: 16px;">
                        –û—Ñ—Ñ–ª–∞–π–Ω
                    </div>
                </div>
            </div>
            
            <div id="voiceChatControls" style="display: none; padding: 10px; background: #3a3a3a; color: white; justify-content: space-between; align-items: center;">
                <span><i class="fas fa-volume-up" style="color: var(--color-primary);"></i> –ê–∫—Ç–∏–≤–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç...</span>
                <div>
                    <button onclick="toggleMute()" style="background: var(--color-input); color: white; border: none; padding: 8px; border-radius: 5px; margin-right: 5px;"><i id="muteIcon" class="fas fa-microphone"></i></button>
                    <button onclick="leaveVoiceChat()" style="background: var(--color-danger); color: white; border: none; padding: 8px; border-radius: 5px;">–ü–æ–∫–∏–Ω—É—Ç—å</button>
                </div>
            </div>
            
            <div id="messageArea">
                <div class="message msg-other">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–∞—Ç—å—Å—è.</div>
            </div>
            
            <div class="chat-input" id="chatInputArea" style="display:none;">
                
                <button onclick="document.getElementById('fileInput').click()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">

                <div id="recorderUI" style="display:none;">
                    <i class="fas fa-microphone-alt"></i> 
                    <span id="recorderTimer">00:00</span>
                    <button id="cancelRecordBtn" onclick="stopRecording(false)" title="–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å">
                        <i class="fas fa-times"></i>
                    </button>
                    <button id="sendVoiceBtn" onclick="stopRecording(true)" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å">
                        <i class="fas fa-check"></i>
                    </button>
                </div>

                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleKeyPress(event)">
                
                <button id="sendTextBtn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="micToggleBtn" onclick="toggleRecording()" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ===========================================
        // üîë –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–ê–®–ò –ö–õ–Æ–ß–ò)
        // ===========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBFBZLS7W9uBqpNItQUeCSYJ2IRG7G5UiA", 
          authDomain: "chat-ca735.firebaseapp.com",
          databaseURL: "https://chat-ca735-default-rtdb.firebaseio.com",
          projectId: "chat-ca735",
          storageBucket: "chat-ca735.firebasestorage.app",
          messagingSenderId: "407446630782",
          appId: "1:407446630782:web:5d9b66c3e8ff051bebc32f",
          measurementId: "G-DJ4K3BB9ZE"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); 
        const rtdb = firebase.database(); 

        // ===========================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ===========================================
        let currentUser = null; 
        let myUsername = null; 
        let activeChatId = null; 
        let unsubscribeFromChat = null; 
        let isPremium = false; 
        let isMuted = false;
        
        // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ Premium —ç–º–æ–¥–∑–∏-—Å—Ç–∞—Ç—É—Å–∞
        const userEmojiStatus = {
            'public_chat': 'üéâ'
        };

        // ===========================================
        // üîê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
        // ===========================================

        function generateRandomUsername() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let username = 'guest_';
            for (let i = 0; i < 6; i++) {
                username += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return username;
        }

        function signInAsGuest() {
            // –°–æ–∑–¥–∞–µ–º –ø—Å–µ–≤–¥–æ-–æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
            const guestUid = `guest-${Date.now()}`;
            const guestUsername = generateRandomUsername();
            
            const guestUser = {
                uid: guestUid,
                displayName: '–ì–æ—Å—Ç—å',
                email: 'guest@example.com',
                isGuest: true
            };
            
            // –ó–∞–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º Firebase Auth
            currentUser = guestUser;
            document.getElementById('googleSignInBtn').style.display = 'none';
            document.getElementById('guestSignInBtn').style.display = 'none';
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≥–æ—Å—Ç—è
            document.getElementById('usernameSetupInput').value = guestUsername;
            document.getElementById('usernameSetup').style.display = 'block';
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    handleAuthSuccess(result.user);
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ Google Auth:", error);
                    showCustomAlert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
                });
        }

        function handleAuthSuccess(user) {
            currentUser = user;
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        myUsername = userData.username;
                        isPremium = userData.isPremium || false; 
                        
                        if (myUsername) {
                            initializeChatApp();
                        } else {
                            document.getElementById('googleSignInBtn').style.display = 'none';
                            document.getElementById('guestSignInBtn').style.display = 'none';
                            document.getElementById('usernameSetup').style.display = 'block';
                        }
                    } else {
                        document.getElementById('googleSignInBtn').style.display = 'none';
                        document.getElementById('guestSignInBtn').style.display = 'none';
                        document.getElementById('usernameSetup').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
                });
        }
        
        function saveUsername() {
            const usernameInput = document.getElementById('usernameSetupInput');
            const errorDiv = document.getElementById('usernameError');
            let usernameValue = usernameInput.value.trim().toLowerCase().replace('@', '');
            
            if (!/^[a-z0-9_]{3,}$/.test(usernameValue)) {
                errorDiv.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –õ–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, "_", –æ—Ç 3 —Å–∏–º–≤–æ–ª–æ–≤.';
                return;
            }
            
            errorDiv.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...';

            db.collection('users').where('username', '==', usernameValue).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        const userData = {
                            uid: currentUser.uid,
                            username: usernameValue,
                            displayName: currentUser.displayName || '–ì–æ—Å—Ç—å',
                            email: currentUser.email || 'guest',
                            isPremium: (Math.random() > 0.8), // 20% —à–∞–Ω—Å Premium
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-–≥–æ—Å—Ç–µ–π –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –≥–æ—Å—Ç—è –≤ –±–∞–∑–µ
                        if (!currentUser.isGuest) {
                             return db.collection('users').doc(currentUser.uid).set(userData);
                        } else {
                            // –î–ª—è –≥–æ—Å—Ç–µ–π –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ users
                            return Promise.resolve();
                        }
                    } else {
                        throw new Error('–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.');
                    }
                })
                .then(() => {
                    myUsername = usernameValue;
                    errorDiv.textContent = '–£—Å–ø–µ—à–Ω–æ! –í—Ö–æ–¥...';
                    initializeChatApp();
                })
                .catch(error => {
                    errorDiv.textContent = error.message;
                    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏:", error);
                });
        }
        
        function logout() {
             if (currentUser.isGuest) {
                 window.location.reload(); // –î–ª—è –≥–æ—Å—Ç–µ–π –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
             } else {
                 auth.signOut().then(() => {
                    window.location.reload();
                 });
             }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                handleAuthSuccess(user);
            } else if (!currentUser || !currentUser.isGuest) {
                document.getElementById('chatApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('usernameSetup').style.display = 'none';
                document.getElementById('googleSignInBtn').style.display = 'flex';
                document.getElementById('guestSignInBtn').style.display = 'flex';
            }
        });

        // ===========================================
        // üíª UI / –ù–ê–í–ò–ì–ê–¶–ò–Ø
        // ===========================================
        
        function initializeChatApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            
            updateMyUsernameDisplay();
            setupPresence(); 
            
            const globalChatLink = document.getElementById('globalChatLink');
            startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç', globalChatLink); 
        }

        function updateMyUsernameDisplay() {
            const myUsernameDisplay = document.getElementById('myUsernameDisplay');
            myUsernameDisplay.innerHTML = `@${myUsername} ${isPremium ? '<i class="fas fa-star" style="color: gold;"></i>' : ''} ${currentUser.isGuest ? '(–ì–æ—Å—Ç—å)' : ''}`;
        }
        
        function toggleSidebar() {
             const sidebar = document.getElementById('sidebar');
             sidebar.classList.toggle('open');
        }

        function updateChatHeader(targetUsername, targetUidOrTag) {
            const headerTitle = document.getElementById('chatHeaderTitle');
            const headerStatus = document.getElementById('chatHeaderStatus');
            const startVoiceChatBtn = document.getElementById('startVoiceChatBtn');
            
            let premiumBadge = isPremium ? '<i class="fas fa-star" style="color: gold; margin-left: 5px;" title="Telegram Premium"></i>' : '';
            
            headerTitle.innerHTML = `–ß–∞—Ç —Å @${targetUsername}${targetUidOrTag === currentUser.uid ? premiumBadge : ''}`;
            
            const activeUserStatus = userEmojiStatus[targetUidOrTag];
            if (activeUserStatus) {
                 headerStatus.innerHTML = `<span title="Premium-—Å—Ç–∞—Ç—É—Å">${activeUserStatus} –≤ —Å–µ—Ç–∏</span>`;
            } else {
                 headerStatus.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...'; 
            }
            
            if (targetUidOrTag === 'public_chat') {
                startVoiceChatBtn.style.display = 'inline';
            } else {
                startVoiceChatBtn.style.display = 'none';
            }
        }
        
        function startNewChat(targetUidOrTag, targetUsername, element = null) {
            document.getElementById('messageArea').innerHTML = '';
            
            if (unsubscribeFromChat) {
                 unsubscribeFromChat();
            }

            activeChatId = targetUidOrTag;
            
            updateChatHeader(targetUsername, targetUidOrTag);
            
            document.getElementById('chatInputArea').style.display = 'flex';
            document.getElementById('messageInput').focus();

            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('open')) {
                toggleSidebar();
            }
            
            listenToChatMessages(targetUidOrTag);
        }

        // ===========================================
        // üü¢ –°–¢–ê–¢–£–° –û–ù–õ–ê–ô–ù
        // ===========================================
        
        function setupPresence() {
            if (!currentUser) return;

            const userStatusRef = rtdb.ref(`/status/${currentUser.uid}`);
            
            const isOnline = {
                state: 'online',
                last_changed: firebase.database.ServerValue.TIMESTAMP
            };
            
            const isOffline = {
                state: 'offline',
                last_changed: firebase.database.ServerValue.TIMESTAMP
            };

            userStatusRef.onDisconnect().set(isOffline).then(() => {
                userStatusRef.set(isOnline);
            });
            
            listenToAllUserStatuses();
        }

        function listenToAllUserStatuses() {
            const statusRef = rtdb.ref('/status');
            statusRef.on('child_changed', (snapshot) => {
                const userId = snapshot.key;
                const status = snapshot.val();
                updateContactStatusUI(userId, status);
            });
        }

        function updateContactStatusUI(userId, status) {
            const contactElement = document.getElementById(`contact-${userId}`);
            
            if (activeChatId === userId || activeChatId === 'public_chat') { 
                const headerStatus = document.getElementById('chatHeaderStatus');
                if (headerStatus) {
                    if (status.state === 'online') {
                         headerStatus.innerHTML = `<span style="color: var(--color-online);"><i class="fas fa-circle"></i> –≤ —Å–µ—Ç–∏</span>`;
                    } else {
                         const time = new Date(status.last_changed).toLocaleTimeString();
                         headerStatus.innerHTML = `–±—ã–ª(–∞) ${time}`;
                    }
                }
            }
            
            if (contactElement) {
                if (status.state === 'online') {
                    contactElement.classList.add('online');
                } else {
                    contactElement.classList.remove('online');
                }
            }
        }

        // ===========================================
        // üéôÔ∏è –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ (Placeholder)
        // ===========================================

        function startVoiceChat() {
            if (!activeChatId) {
                showCustomAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç.");
                return;
            }
            
            document.getElementById('voiceChatControls').style.display = 'flex';
            document.getElementById('startVoiceChatBtn').style.display = 'none';
            showCustomAlert("–ó–∞–ø—É—Å–∫ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç–∞ (–¢—Ä–µ–±—É–µ—Ç—Å—è WebRTC)! üìû");
        }

        function toggleMute() {
            isMuted = !isMuted;
            const muteIcon = document.getElementById('muteIcon');
            if (isMuted) {
                muteIcon.className = 'fas fa-microphone-slash';
                showCustomAlert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω.");
            } else {
                muteIcon.className = 'fas fa-microphone';
                showCustomAlert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω.");
            }
        }

        function leaveVoiceChat() {
            document.getElementById('voiceChatControls').style.display = 'none';
            document.getElementById('startVoiceChatBtn').style.display = 'inline';
            showCustomAlert("–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç. üëã");
        }

        // ===========================================
        // üí¨ –ß–ê–¢: –û–¢–ü–†–ê–í–ö–ê –ò –ü–†–û–°–õ–£–®–ö–ê
        // ===========================================

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'fas fa-image';
            if (mimeType.startsWith('audio/')) return 'fas fa-music';
            if (mimeType.startsWith('video/')) return 'fas fa-video';
            if (mimeType.includes('pdf')) return 'fas fa-file-pdf';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return 'fas fa-file-archive';
            return 'fas fa-file';
        }

        function createMessageElement(text, time, isUser, fileUrl = null, fileName = null, fileType = null, fileSize = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isUser ? 'msg-user' : 'msg-other');
            
            if (fileUrl) {
                if (fileType && fileType.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = fileUrl;
                    img.alt = fileName || "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ";
                    messageDiv.appendChild(img);
                } else if (fileType && fileType.startsWith('audio/')) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = fileUrl;
                    messageDiv.appendChild(audio);
                    
                    if (isPremium) {
                        messageDiv.innerHTML += '<div style="margin-top: 5px; background: #555; padding: 5px; border-radius: 5px; font-size: 0.8em;"><i class="fas fa-star" style="color: gold;"></i> **–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (Premium):** [–¢–µ–∫—Å—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏...]</div>';
                    }
                } else {
                    // –û–±—â–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤
                    const fileWrapper = document.createElement('a');
                    fileWrapper.href = fileUrl;
                    fileWrapper.target = '_blank';
                    fileWrapper.className = 'file-icon-wrapper';
                    
                    const icon = document.createElement('i');
                    icon.className = getFileIcon(fileType);
                    
                    const info = document.createElement('div');
                    info.className = 'file-info';
                    info.innerHTML = `<span class="file-name">${fileName}</span><span class="file-size">${formatBytes(fileSize || 0)}</span>`;
                    
                    fileWrapper.appendChild(icon);
                    fileWrapper.appendChild(info);
                    messageDiv.appendChild(fileWrapper);
                }
                
                if (text) {
                     const textNode = document.createTextNode(text);
                     messageDiv.appendChild(document.createElement('br'));
                     messageDiv.appendChild(textNode);
                }
            } else {
                 messageDiv.innerHTML = text; // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            }

            const timeSpan = document.createElement('span');
            timeSpan.className = 'msg-time';
            timeSpan.textContent = time;
            messageDiv.appendChild(timeSpan);
            
            return messageDiv;
        }

        function listenToChatMessages(chatId) {
            const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp');
            
            unsubscribeFromChat = messagesRef.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const msg = change.doc.data();
                        const messageArea = document.getElementById('messageArea');
                        const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '—Å–µ–π—á–∞—Å';
                        
                        const msgElement = createMessageElement(
                            msg.text, 
                            time, 
                            msg.senderId === currentUser.uid, 
                            msg.fileUrl, 
                            msg.fileName, 
                            msg.fileType,
                            msg.fileSize
                        );
                        
                        messageArea.appendChild(msgElement);
                        messageArea.scrollTop = messageArea.scrollHeight;
                    }
                });
            }, error => {
                 console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —á–∞—Ç–∞:", error);
            });
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !activeChatId) return;

            const storageRef = storage.ref();
            const fileRef = storageRef.child(`chats/${activeChatId}/${Date.now()}_${file.name}`);
            
            const uploadTask = fileRef.put(file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ ' + progress.toFixed(0) + '%');
                    document.getElementById('chatHeaderStatus').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${progress.toFixed(0)}%`;
                }, 
                (error) => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", error);
                    showCustomAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.");
                    document.getElementById('chatHeaderStatus').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        const messageText = document.getElementById('messageInput').value.trim();
                        sendMessageToDB(messageText, downloadURL, file.name, file.type, file.size);
                        
                        document.getElementById('messageInput').value = ''; 
                        event.target.value = '';
                        document.getElementById('chatHeaderStatus').textContent = '–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
                    });
                }
            );
        }

        function sendMessageToDB(text, fileUrl = null, fileName = null, fileType = null, fileSize = null) {
             if (!currentUser || !activeChatId) return;
             
             // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: **–∂–∏—Ä–Ω—ã–π** –∏ *–∫—É—Ä—Å–∏–≤*
             const formattedText = text
                 .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                 .replace(/\*(.*?)\*/g, '<i>$1</i>');
             
             const messageData = {
                 senderId: currentUser.uid,
                 senderUsername: myUsername,
                 text: formattedText,
                 timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                 fileUrl: fileUrl,
                 fileName: fileName,
                 fileType: fileType,
                 fileSize: fileSize
             };

             db.collection('chats').doc(activeChatId).collection('messages').add(messageData)
                 .then(() => {
                     console.log("–°–æ–æ–±—â–µ–Ω–∏–µ/–º–µ–¥–∏–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.");
                 })
                 .catch((error) => {
                     console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                 });
        }
        
        function sendMessage() {
            const text = document.getElementById('messageInput').value.trim();
            if (text === '') return;
            
            sendMessageToDB(text);
            document.getElementById('messageInput').value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function toggleRecording() {
            showCustomAlert("–§—É–Ω–∫—Ü–∏—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞ –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!");
        }
        function stopRecording(send) {
             showCustomAlert(`–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞ ${send ? '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' : '–æ—Ç–º–µ–Ω–µ–Ω–∞'}. (–≠—Ç–æ –∑–∞–≥–ª—É—à–∫–∞)`);
        }
        
        // ===========================================
        // ‚ö†Ô∏è –ö–ê–°–¢–û–ú–ù–´–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø
        // ===========================================
        function showCustomAlert(message) {
             alert(message);
        }
        
    </script>
</body>
</html>
