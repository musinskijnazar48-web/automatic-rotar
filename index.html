<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä: Telegram Style (v3)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script> 

    <style>
        /* =========================================== */
        /* üé® –°–¢–ò–õ–ò (CSS) */
        /* =========================================== */
        :root {
            --bg-dark: #0f0f0f;
            --bg-container: #1a1a1a;
            --bg-sidebar: #222222;
            --color-primary: #0088cc; 
            --color-secondary: #00aaff;
            --color-text: #f0f0f0;
            --color-input: #333333;
            --color-border: #444444;
            --color-danger: #ff5555;
            
            --color-online: #42b72a; 
            --color-gradient-start: #0093E9;
            --color-gradient-end: #80D0C4;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-dark); 
            color: var(--color-text); 
            padding: 0; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-size: 14px;
        }
        .app-container { 
            width: 95%; 
            max-width: 1000px; 
            height: 90vh; 
            min-height: 600px;
            background: var(--bg-container); 
            border-radius: 18px; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7); 
            display: flex; 
            overflow: hidden; 
        }

        button, .contact-item, .message { transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        .message:hover { transform: scale(1.01); }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #loginScreen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); display: flex; justify-content: center; 
            align-items: center; z-index: 100; 
        }
        #loginBox { 
            background: var(--bg-sidebar); 
            padding: 50px; 
            border-radius: 12px; 
            text-align: center; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        .login-btn-group button { 
            padding: 15px 30px; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 1.2em;
            display: flex;
            align-items: center;
            margin: 15px auto;
            width: 300px;
            justify-content: center;
        }
        #googleSignInBtn { 
            background: #4285F4; 
        }
        #guestSignInBtn { 
            background: #6a6a6a; 
        }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar { 
            width: 30%; 
            min-width: 250px; 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--color-border); 
            display: flex; 
            flex-direction: column; 
        }
        
        .badge-icon {
            margin-left: 5px;
            font-size: 1.1em;
            vertical-align: middle;
            transition: transform 0.2s;
        }
        .badge-icon:hover {
            transform: scale(1.2);
        }

        /* –û–ö–ù–û –ß–ê–¢–ê */
        #chatWindow { width: 70%; display: flex; flex-direction: column; }
        .chat-header { 
            padding: 15px 20px; 
            background: var(--bg-sidebar); 
            border-bottom: 1px solid var(--color-border); 
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }
        .chat-input { 
            display: flex; 
            padding: 10px 15px; 
            background: var(--bg-sidebar); 
            border-top: 1px solid var(--color-border); 
            align-items: center;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–∏—Å–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã" */
        #channelReadOnlyOverlay {
            padding: 12px;
            text-align: center;
            background: #333333;
            color: #aaaaaa;
            border-radius: 15px;
            margin: 10px 15px;
            font-size: 0.9em;
        }

    </style>
</head>
<body>
    
    <div id="loginScreen">
        <div id="loginBox">
            <h2><i class="fab fa-telegram-plane"></i> –ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞:</p>
            
            <div class="login-btn-group">
                <button id="googleSignInBtn" onclick="signInWithGoogle()"><i class="fab fa-google"></i> –†–∞–±–æ—á–∏–π (Google)</button>
                <button id="guestSignInBtn" onclick="signInAsGuest()"><i class="fas fa-user-secret"></i> –ì–æ—Å—Ç–µ–≤–æ–π (–ê–Ω–æ–Ω–∏–º–Ω–æ)</button>
            </div>
            
            <div id="usernameSetup" style="display:none;">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫ –≤ TG):</p>
                <input type="text" id="usernameSetupInput" placeholder="@username (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)">
                <button onclick="saveUsername()"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <div id="usernameError" style="color: var(--color-danger); margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <div class="app-container" id="chatApp" style="display:none;">
        
        <div id="sidebar">
            <div id="searchBox">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ @username..." oninput="searchUsers(this.value)">
            </div>
            <div id="contactList">
                <div class="contact-item" id="globalChatLink" onclick="startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç', this, 'group')">
                    <div class="contact-avatar-wrapper">
                        <div class="avatar">G</div>
                        <span class="online-status-dot"></span>
                    </div>
                    <div class="contact-item-info">
                        <div class="contact-item-name">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</div>
                        <div class="contact-item-username">@public</div>
                    </div>
                </div>
                <div class="contact-item" id="channelLink" onclick="startNewChat('tech_channel', '–ù–æ–≤–æ—Å—Ç–Ω–æ–π –ö–∞–Ω–∞–ª', this, 'channel')">
                    <div class="contact-avatar-wrapper">
                        <div class="avatar" style="background: purple;"><i class="fas fa-bullhorn"></i></div>
                        <span class="online-status-dot"></span>
                    </div>
                    <div class="contact-item-info">
                        <div class="contact-item-name">–ù–æ–≤–æ—Å—Ç–Ω–æ–π –ö–∞–Ω–∞–ª</div>
                        <div class="contact-item-username">@tech</div>
                    </div>
                </div>
                </div>
            <div class="logout-btn" onclick="openProfileModal()">
                <i class="fas fa-user-circle"></i> –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å (<span id="myUsernameDisplay"></span>)
            </div>
            <div class="logout-btn" style="color: var(--color-danger);" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
            </div>
        </div>

        <div id="chatWindow">
            <div class="chat-header" id="chatHeader">
                <i id="menuToggle" class="fas fa-bars" onclick="toggleSidebar()"></i>
                
                <button id="startVoiceChatBtn" onclick="startVoiceChat()" title="–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç" style="background: none; border: none; color: var(--color-secondary); font-size: 1.1em; margin-left: 10px; cursor: pointer; display:none;">
                    <i class="fas fa-headset"></i>
                </button>
                
                <div style="display: flex; flex-direction: column; margin-left: 10px;">
                    <span id="chatHeaderTitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span> 
                    <div id="chatHeaderStatus" style="font-size: 0.8em; color: #aaa; height: 16px;">
                        –û—Ñ—Ñ–ª–∞–π–Ω
                    </div>
                </div>
            </div>
            
            <div id="voiceChatControls" style="display: none; padding: 10px; background: #3a3a3a; color: white; justify-content: space-between; align-items: center;">
                <span><i class="fas fa-volume-up" style="color: var(--color-primary);"></i> –ê–∫—Ç–∏–≤–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç...</span>
                <div>
                    <button onclick="toggleMute()" style="background: var(--color-input); color: white; border: none; padding: 8px; border-radius: 5px; margin-right: 5px;"><i id="muteIcon" class="fas fa-microphone"></i></button>
                    <button onclick="leaveVoiceChat()" style="background: var(--color-danger); color: white; border: none; padding: 8px; border-radius: 5px;">–ü–æ–∫–∏–Ω—É—Ç—å</button>
                </div>
            </div>
            
            <div id="messageArea">
                <div class="message msg-other">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–∞—Ç—å—Å—è.</div>
            </div>
            
            <div id="channelReadOnlyOverlay" style="display: none;">
                <i class="fas fa-lock"></i> –¢–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è. –ü–∏—Å–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã.
            </div>
            
            <div class="chat-input" id="chatInputArea" style="display:none;">
                <button onclick="document.getElementById('fileInput').click()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">

                <div id="recorderUI" style="display:none;">
                    <i class="fas fa-microphone-alt"></i> 
                    <span id="recorderTimer">00:00</span>
                    <button id="cancelRecordBtn" onclick="stopRecording(false)" title="–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å">
                        <i class="fas fa-times"></i>
                    </button>
                    <button id="sendVoiceBtn" onclick="stopRecording(true)" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å">
                        <i class="fas fa-check"></i>
                    </button>
                </div>

                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleKeyPress(event)">
                
                <button id="sendTextBtn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="micToggleBtn" onclick="toggleRecording()" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div id="profileModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 200; justify-content: center; align-items: center;">
        <div id="profileContent" style="background: var(--bg-container); padding: 30px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);">
            <i class="fas fa-times" onclick="closeProfileModal()" style="position: absolute; top: 15px; right: 15px; color: #fff; cursor: pointer;"></i>
            
            <h2>–í–∞—à –ü—Ä–æ—Ñ–∏–ª—å</h2>
            
            <div id="profileAvatarWrapper" style="position: relative; width: 100px; height: 100px; margin: 0 auto 20px;">
                <img id="profileAvatarImg" src="https://via.placeholder.com/100" alt="–ê–≤–∞—Ç–∞—Ä" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid var(--color-primary);">
                <button onclick="document.getElementById('avatarFileInput').click()" style="position: absolute; bottom: 0; right: 0; background: var(--color-primary); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 1em; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);">
                    <i class="fas fa-camera"></i>
                </button>
                <input type="file" id="avatarFileInput" style="display: none;" accept="image/*" onchange="uploadAvatar(event)">
            </div>
            
            <div style="text-align: left; margin-top: 15px;">
                <p><strong>–ò–º—è:</strong> <span id="profileDisplayName">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
                <p><strong>@username:</strong> <span id="profileUsername">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
                <p><strong>UID:</strong> <span id="profileUID">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
                <p id="profilePremiumStatus">
                    <strong>Premium:</strong> 
                    <span style="color: grey;">–ù–µ—Ç</span>
                </p>
                
                <hr style="border-color: #333; margin: 15px 0;">
                <p><strong>–í–∞—à –ó–Ω–∞—á–æ–∫:</strong> 
                    <span id="currentBadge">–ù–µ—Ç</span>
                    <i class="fas fa-edit" onclick="openBadgeSelection()" style="cursor: pointer; margin-left: 10px;"></i>
                </p>
                
                <div id="adminPanel" style="display:none; margin-top: 20px; padding: 10px; border: 1px dashed gold;">
                    <h4><i class="fas fa-crown" style="color: gold;"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Premium</h4>
                    <input type="text" id="targetUsernameInput" placeholder="@username –¥–ª—è Premium" style="width: 100%; padding: 8px; margin-bottom: 10px; background: var(--color-input); border: none; border-radius: 5px; color: white;">
                    <button onclick="togglePremiumStatus(true)" style="background: var(--color-primary); margin-right: 5px;">–í—ã–¥–∞—Ç—å Premium</button>
                    <button onclick="togglePremiumStatus(false)" style="background: var(--color-danger);">–û—Ç–æ–±—Ä–∞—Ç—å Premium</button>
                </div>

            </div>
            
            <button onclick="logout()" style="background: var(--color-danger); color: white; margin-top: 20px; padding: 10px 20px; border-radius: 8px;">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            </button>
        </div>
    </div>
    
    <div id="badgeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 201; justify-content: center; align-items: center;">
        <div style="background: var(--bg-container); padding: 30px; border-radius: 15px; width: 300px; text-align: center;">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ó–Ω–∞—á–æ–∫ (Premium)</h3>
            <p style="font-size: 0.9em; color: #aaa;">–ó–Ω–∞—á–æ–∫ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–æ–∑–ª–µ –≤–∞—à–µ–≥–æ –∏–º–µ–Ω–∏.</p>
            <div id="badgeSelectionArea" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px;">
                </div>
            <button onclick="closeBadgeSelection()" style="background: #333; margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // ===========================================
        // üîë –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–ê–®–ò –ö–õ–Æ–ß–ò)
        // ===========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBFBZLS7W9uBqpNItQUeCSYJ2IRG7G5UiA", 
          authDomain: "chat-ca735.firebaseapp.com",
          databaseURL: "https://chat-ca735-default-rtdb.firebaseio.com",
          projectId: "chat-ca735",
          storageBucket: "chat-ca735.firebasestorage.app",
          messagingSenderId: "407446630782",
          appId: "1:407446630782:web:5d9b66c3e8ff051bebc32f",
          measurementId: "G-DJ4K3BB9ZE"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); 
        const rtdb = firebase.database(); 

        // ===========================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ===========================================
        let currentUser = null; 
        let myUsername = null; 
        let activeChatId = null; 
        let activeChatType = 'group'; // 'group' –∏–ª–∏ 'channel'
        let unsubscribeFromChat = null; 
        let isPremium = false; 
        let isMuted = false;
        let myBadge = null; // –ù–æ–≤—ã–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å-–∑–Ω–∞—á–æ–∫
        
        // –ó–Ω–∞—á–∫–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è Premium
        const PREMIUM_BADGES = [
            '‚≠ê', 'üëë', 'üöÄ', 'üíª', 'üí°', 'üî•'
        ];
        
        const ADMIN_USERNAME = 'ghost'; // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∞

        // ===========================================
        // üîê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
        // ===========================================

        function generateRandomUsername() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let username = 'guest_';
            for (let i = 0; i < 6; i++) {
                username += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return username;
        }

        function signInAsGuest() {
            const guestUid = `guest-${Date.now()}`;
            const guestUsername = generateRandomUsername();
            
            const guestUser = {
                uid: guestUid,
                displayName: '–ì–æ—Å—Ç—å',
                email: 'guest@example.com',
                isGuest: true
            };
            
            currentUser = guestUser;
            document.getElementById('googleSignInBtn').style.display = 'none';
            document.getElementById('guestSignInBtn').style.display = 'none';
            
            document.getElementById('usernameSetupInput').value = guestUsername;
            document.getElementById('usernameSetup').style.display = 'block';
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    handleAuthSuccess(result.user);
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ Google Auth:", error);
                    showCustomAlert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
                });
        }

        function handleAuthSuccess(user) {
            currentUser = user;
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        myUsername = userData.username;
                        isPremium = userData.isPremium || false; 
                        myBadge = userData.badge || null; // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–Ω–∞—á–æ–∫
                        
                        if (myUsername) {
                            initializeChatApp();
                        } else {
                            document.getElementById('googleSignInBtn').style.display = 'none';
                            document.getElementById('guestSignInBtn').style.display = 'none';
                            document.getElementById('usernameSetup').style.display = 'block';
                        }
                    } else {
                        document.getElementById('googleSignInBtn').style.display = 'none';
                        document.getElementById('guestSignInBtn').style.display = 'none';
                        document.getElementById('usernameSetup').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
                });
        }
        
        function saveUsername() {
            const usernameInput = document.getElementById('usernameSetupInput');
            const errorDiv = document.getElementById('usernameError');
            let usernameValue = usernameInput.value.trim().toLowerCase().replace('@', '');
            
            if (!/^[a-z0-9_]{3,}$/.test(usernameValue)) {
                errorDiv.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –õ–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, "_", –æ—Ç 3 —Å–∏–º–≤–æ–ª–æ–≤.';
                return;
            }
            
            errorDiv.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...';

            db.collection('users').where('username', '==', usernameValue).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        const userData = {
                            uid: currentUser.uid,
                            username: usernameValue,
                            displayName: currentUser.displayName || '–ì–æ—Å—Ç—å',
                            email: currentUser.email || 'guest',
                            isPremium: (usernameValue === ADMIN_USERNAME) || (Math.random() > 0.8), 
                            badge: null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // –ï—Å–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = 'ghost', —Å—Ä–∞–∑—É –≤—ã–¥–∞–µ–º –µ–º—É Premium
                        if (usernameValue === ADMIN_USERNAME) {
                            userData.isPremium = true;
                        }

                        if (!currentUser.isGuest) {
                             return db.collection('users').doc(currentUser.uid).set(userData);
                        } else {
                            // –î–ª—è –≥–æ—Å—Ç–µ–π –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                            myUsername = usernameValue;
                            isPremium = userData.isPremium;
                            return Promise.resolve();
                        }
                    } else {
                        throw new Error('–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.');
                    }
                })
                .then(() => {
                    myUsername = usernameValue;
                    errorDiv.textContent = '–£—Å–ø–µ—à–Ω–æ! –í—Ö–æ–¥...';
                    initializeChatApp();
                })
                .catch(error => {
                    errorDiv.textContent = error.message;
                    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏:", error);
                });
        }
        
        function logout() {
             if (currentUser.isGuest) {
                 window.location.reload(); 
             } else {
                 auth.signOut().then(() => {
                    window.location.reload();
                 });
             }
        }

        // ===========================================
        // üíª UI / –ù–ê–í–ò–ì–ê–¶–ò–Ø
        // ===========================================
        
        function initializeChatApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            
            updateMyUsernameDisplay();
            setupPresence(); 
            
            const globalChatLink = document.getElementById('globalChatLink');
            startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç', globalChatLink, 'group'); 
        }

        function updateMyUsernameDisplay() {
            const badgeIcon = myBadge ? `<span class="badge-icon">${myBadge}</span>` : '';
            const premiumStar = isPremium ? '<i class="fas fa-star" style="color: gold;"></i>' : '';
            const guestTag = currentUser.isGuest ? '(–ì–æ—Å—Ç—å)' : '';
            
            const myUsernameDisplay = document.getElementById('myUsernameDisplay');
            myUsernameDisplay.innerHTML = `@${myUsername} ${premiumStar} ${badgeIcon} ${guestTag}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - Ghost
            if (myUsername === ADMIN_USERNAME) {
                document.getElementById('adminPanel').style.display = 'block';
            }
        }
        
        function updateChatHeader(targetUsername, targetUidOrTag, chatType) {
            const headerTitle = document.getElementById('chatHeaderTitle');
            const headerStatus = document.getElementById('chatHeaderStatus');
            const startVoiceChatBtn = document.getElementById('startVoiceChatBtn');
            
            let premiumBadge = isPremium ? '<i class="fas fa-star" style="color: gold; margin-left: 5px;" title="Telegram Premium"></i>' : '';
            
            headerTitle.innerHTML = `–ß–∞—Ç —Å @${targetUsername}${targetUidOrTag === currentUser.uid ? premiumBadge : ''}`;
            
            const chatTypeIcon = chatType === 'channel' ? '<i class="fas fa-bullhorn" style="color: #ccc;"></i> –ö–∞–Ω–∞–ª' : '<i class="fas fa-users" style="color: #ccc;"></i> –ì—Ä—É–ø–ø–∞';
            
            headerStatus.innerHTML = chatTypeIcon; 
            
            if (chatType === 'group') {
                startVoiceChatBtn.style.display = 'inline';
            } else {
                startVoiceChatBtn.style.display = 'none';
            }
        }
        
        function startNewChat(targetUidOrTag, targetUsername, element = null, chatType = 'group') {
            document.getElementById('messageArea').innerHTML = '';
            
            if (unsubscribeFromChat) {
                 unsubscribeFromChat();
            }

            activeChatId = targetUidOrTag;
            activeChatType = chatType;
            
            updateChatHeader(targetUsername, targetUidOrTag, chatType);
            
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è –ö–∞–Ω–∞–ª–æ–≤ (–¢–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)
            const isChannelAdmin = (myUsername === ADMIN_USERNAME);
            const chatInputArea = document.getElementById('chatInputArea');
            const readOnlyOverlay = document.getElementById('channelReadOnlyOverlay');
            
            if (chatType === 'channel' && !isChannelAdmin) {
                chatInputArea.style.display = 'none';
                readOnlyOverlay.style.display = 'block';
            } else {
                chatInputArea.style.display = 'flex';
                readOnlyOverlay.style.display = 'none';
                document.getElementById('messageInput').focus();
            }

            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('open')) {
                toggleSidebar();
            }
            
            listenToChatMessages(targetUidOrTag);
        }

        // ===========================================
        // üí¨ –ß–ê–¢: –û–¢–ü–†–ê–í–ö–ê
        // ===========================================
        
        function sendMessageToDB(text, fileUrl = null, fileName = null, fileType = null, fileSize = null) {
             if (!currentUser || !activeChatId) return;
             
             // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–∞–≤–æ –ø–∏—Å–∞—Ç—å –≤ –ö–∞–Ω–∞–ª–µ
             if (activeChatType === 'channel' && myUsername !== ADMIN_USERNAME) {
                 showCustomAlert("–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
                 return;
             }
             
             const formattedText = text
                 .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                 .replace(/\*(.*?)\*/g, '<i>$1</i>');
             
             const messageData = {
                 senderId: currentUser.uid,
                 senderUsername: myUsername,
                 text: formattedText,
                 timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                 fileUrl: fileUrl,
                 fileName: fileName,
                 fileType: fileType,
                 fileSize: fileSize
             };

             db.collection('chats').doc(activeChatId).collection('messages').add(messageData)
                 .then(() => {
                     console.log("–°–æ–æ–±—â–µ–Ω–∏–µ/–º–µ–¥–∏–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.");
                 })
                 .catch((error) => {
                     console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                 });
        }
        
        function sendMessage() {
            const text = document.getElementById('messageInput').value.trim();
            if (text === '') return;
            
            sendMessageToDB(text);
            document.getElementById('messageInput').value = '';
        }

        // ===========================================
        // ‚≠ê –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–ï PREMIUM (–¥–ª—è @Ghost)
        // ===========================================

        function togglePremiumStatus(status) {
            if (myUsername !== ADMIN_USERNAME) {
                showCustomAlert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –≤—ã–¥–∞—á–∏ Premium.");
                return;
            }

            const targetUsername = document.getElementById('targetUsernameInput').value.trim().replace('@', '');
            if (!targetUsername) {
                showCustomAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
                return;
            }

            db.collection('users').where('username', '==', targetUsername).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        showCustomAlert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @${targetUsername} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
                        return;
                    }
                    
                    const userDoc = snapshot.docs[0];
                    return db.collection('users').doc(userDoc.id).update({
                        isPremium: status
                    }).then(() => {
                        showCustomAlert(`–°—Ç–∞—Ç—É—Å Premium –¥–ª—è @${targetUsername}: ${status ? '–í–´–î–ê–ù' : '–û–¢–û–ë–†–ê–ù'}.`);
                    });
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ Premium:", error);
                    showCustomAlert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.");
                });
        }

        // ===========================================
        // ‚ú® –°–¢–ò–ö–ï–†–´/–ó–ù–ê–ß–ö–ò –ü–†–û–§–ò–õ–Ø
        // ===========================================
        
        function openBadgeSelection() {
            if (!isPremium) {
                showCustomAlert("–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Premium-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.");
                return;
            }
            
            const area = document.getElementById('badgeSelectionArea');
            area.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ë–µ–∑ –∑–Ω–∞—á–∫–∞"
            area.innerHTML += `<button onclick="selectBadge(null)" style="background: var(--color-input); color: white; border: 1px dashed #666; padding: 10px;">(–ë–µ–∑ –∑–Ω–∞—á–∫–∞)</button>`;

            PREMIUM_BADGES.forEach(badge => {
                area.innerHTML += `<button onclick="selectBadge('${badge}')" style="font-size: 2em; padding: 10px; background: #3a3a3a; border: none; border-radius: 8px;">${badge}</button>`;
            });
            
            document.getElementById('badgeModal').style.display = 'flex';
        }

        function closeBadgeSelection() {
            document.getElementById('badgeModal').style.display = 'none';
        }

        function selectBadge(badge) {
            const newBadge = badge === 'null' ? null : badge;
            
            // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            db.collection('users').doc(currentUser.uid).update({
                badge: newBadge
            }).then(() => {
                // 2. –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏ UI
                myBadge = newBadge;
                updateMyUsernameDisplay();
                document.getElementById('currentBadge').textContent = newBadge || '–ù–µ—Ç';
                closeBadgeSelection();
                showCustomAlert("–í–∞—à –∑–Ω–∞—á–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω!");
            }).catch(e => {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–∫–∞:", e);
                showCustomAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–∫–∞.");
            });
        }

        // ===========================================
        // (–û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ - setupPresence, VoiceChat, Media, ProfileModal - –æ—Å—Ç–∞–µ—Ç—Å—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞)
        // ... (–ß—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ–≥—Ä–æ–º–Ω—ã–π –∫–æ–¥, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–Ω —É–∂–µ –µ—Å—Ç—å) ...
        // ===========================================

        // Placeholder –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (–≤ —Ü–µ–ª—è—Ö —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞)
        function loadProfileData() {
             // ... –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
             document.getElementById('profileDisplayName').textContent = currentUser.displayName || myUsername || '–ì–æ—Å—Ç—å';
             document.getElementById('profileUsername').textContent = `@${myUsername || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`;
             document.getElementById('profileUID').textContent = currentUser.uid;
             document.getElementById('currentBadge').textContent = myBadge || '–ù–µ—Ç';
             // ...
        }
        function openProfileModal() { /* ... */ }
        function closeProfileModal() { /* ... */ }
        function uploadAvatar(event) { /* ... */ }
        function setupPresence() { /* ... */ }
        function listenToAllUserStatuses() { /* ... */ }
        function updateContactStatusUI(userId, status) { /* ... */ }
        function startVoiceChat() { /* ... */ }
        function toggleMute() { /* ... */ }
        function leaveVoiceChat() { /* ... */ }
        function handleFileUpload(event) { /* ... */ }
        function showCustomAlert(message) { alert(message); }
        function listenToChatMessages(chatId) { /* ... */ }
        function createMessageElement(text, time, isUser, fileUrl, fileName, fileType, fileSize) { /* ... */ }
        function handleKeyPress(event) { if (event.key === 'Enter') sendMessage(); }
        function toggleRecording() { showCustomAlert("–§—É–Ω–∫—Ü–∏—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞ –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!"); }
        function stopRecording(send) { showCustomAlert(`–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞ ${send ? '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' : '–æ—Ç–º–µ–Ω–µ–Ω–∞'}. (–≠—Ç–æ –∑–∞–≥–ª—É—à–∫–∞)`); }
        
        // *************************************************************************
        // –í–ù–ò–ú–ê–ù–ò–ï: –í –†–ï–ê–õ–¨–ù–û–ú –ö–û–î–ï –í–ê–ú –ù–£–ñ–ù–û –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –í–ï–°–¨ –ö–û–î –ò–ó –ü–†–ï–î–´–î–£–©–ï–ì–û
        // –®–ê–ì–ê, –í–ö–õ–Æ–ß–ê–Ø –í–°–ï –§–£–ù–ö–¶–ò–ò, –ö–û–¢–û–†–´–ï –ó–î–ï–°–¨ –£–ö–ê–ó–ê–ù–´ –ö–ê–ö PLACEHOLDER.
        // *************************************************************************
    </script>
</body>
</html>
