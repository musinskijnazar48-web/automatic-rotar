<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä: –°—Ç–∏–ª—å –∏ –ú–µ–¥–∏–∞</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ë–ò–ë–õ–ò–û–¢–ï–ö FIREBASE -->
    <!-- –î–æ–±–∞–≤–ª—è–µ–º Storage –¥–ª—è —Ñ–∞–π–ª–æ–≤ –∏ –≥–æ–ª–æ—Å–∞ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        :root {
            --bg-dark: #0f0f0f;
            --bg-container: #1a1a1a;
            --bg-sidebar: #222222;
            --color-primary: #0088cc; /* –ë–æ–ª–µ–µ "—Ç–µ–ª–µ–≥—Ä–∞–º–Ω—ã–π" —Å–∏–Ω–∏–π */
            --color-secondary: #00aaff;
            --color-text: #f0f0f0;
            --color-input: #333333;
            --color-border: #444444;
            --color-danger: #ff5555;
        }
        
        /* –û–±—â–∏–π —Å—Ç–∏–ª—å */
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-dark); 
            color: var(--color-text); 
            padding: 0; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-size: 14px;
        }
        .app-container { 
            width: 95%; /* –ß—É—Ç—å —à–∏—Ä–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
            max-width: 1000px; 
            height: 90vh; 
            min-height: 600px;
            background: var(--bg-container); 
            border-radius: 18px; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7); /* –ì–ª—É–±–æ–∫–∞—è —Ç–µ–Ω—å */
            display: flex; 
            overflow: hidden; 
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        button, .contact-item { transition: all 0.2s ease-in-out; }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }
        button:active { transform: translateY(0); }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #loginScreen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); display: flex; justify-content: center; 
            align-items: center; z-index: 100; 
        }
        #loginBox { 
            background: var(--bg-sidebar); 
            padding: 50px; 
            border-radius: 12px; 
            text-align: center; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        #googleSignInBtn { 
            padding: 15px 30px; 
            background: #4285F4; /* Google Blue */
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 1.2em;
            display: flex;
            align-items: center;
            margin: 20px auto 0;
        }
        #googleSignInBtn i { margin-right: 10px; }
        #usernameSetup input { background: var(--color-input); border-color: var(--color-border); }
        #usernameSetup button { background: var(--color-primary); }

        /* –°–ê–ô–î–ë–ê–† (–°–ü–ò–°–û–ö –ß–ê–¢–û–í) */
        #sidebar { 
            width: 30%; 
            min-width: 250px; 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--color-border); 
            display: flex; 
            flex-direction: column; 
        }
        #searchBox { padding: 15px; border-bottom: 1px solid var(--color-border); }
        #searchBox input { 
            background: var(--color-input); 
            color: var(--color-text); 
            border: none; 
            padding: 10px; 
            border-radius: 20px; 
            width: 100%; 
        }
        .contact-item { 
            padding: 15px; 
            border-bottom: 1px solid #333333; 
        }
        .contact-item:hover, .contact-item.active { background: #333333; }
        .contact-item-name { color: white; }
        .contact-item-username { color: #aaaaaa; font-size: 0.85em; }
        .logout-btn { 
            color: var(--color-danger); 
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 85, 85, 0.3);
        }

        /* –û–ö–ù–û –ß–ê–¢–ê */
        #chatWindow { width: 70%; display: flex; flex-direction: column; }
        .chat-header { 
            padding: 15px 20px; 
            background: var(--bg-sidebar); 
            border-bottom: 1px solid var(--color-border); 
            font-size: 1.3em;
        }
        #messageArea { 
            flex-grow: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message { 
            padding: 12px 18px; 
            border-radius: 20px; 
            max-width: 75%; 
            line-height: 1.5; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .msg-user { 
            background: var(--color-primary); 
            color: white; 
            align-self: flex-end; 
            border-bottom-right-radius: 4px; /* "–•–≤–æ—Å—Ç–∏–∫" */
        }
        .msg-other { 
            background: var(--color-input); 
            color: var(--color-text); 
            align-self: flex-start; 
            border-bottom-left-radius: 4px; /* "–•–≤–æ—Å—Ç–∏–∫" */
        }
        .msg-sender { font-weight: bold; font-size: 0.9em; margin-bottom: 5px; color: var(--color-secondary); }
        .msg-time { 
            font-size: 0.7em; 
            opacity: 0.6; 
            margin-top: 5px;
            display: block;
            text-align: right;
        }

        /* –ú–µ–¥–∏–∞ –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 5px;
            display: block;
        }
        .message audio {
            width: 100%;
            margin-top: 5px;
            height: 35px;
        }
        .file-link {
            display: block;
            color: var(--color-secondary);
            text-decoration: underline;
        }


        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .chat-input { 
            display: flex; 
            padding: 10px 15px; 
            background: var(--bg-sidebar); 
            border-top: 1px solid var(--color-border); 
            align-items: center;
        }
        .chat-input input[type="text"] { 
            flex-grow: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 25px; 
            background: var(--color-input); 
            color: var(--color-text); 
            margin: 0 8px; 
            font-size: 1em;
        }
        .chat-input button {
            background: none;
            border: none;
            color: var(--color-secondary);
            font-size: 1.5em;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            padding: 0;
        }
        .chat-input button#sendTextBtn {
            background: var(--color-primary);
            color: white;
            font-size: 1.2em;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞ */
        #recorderUI {
            display: none;
            flex-grow: 1;
            align-items: center;
            gap: 10px;
            color: var(--color-danger);
            font-weight: bold;
        }
        #recorderUI.active {
            display: flex;
        }
        #recorderTimer {
            font-size: 1.1em;
            margin-left: 10px;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        #cancelRecordBtn { color: white; background: var(--color-danger); }
        #sendVoiceBtn { color: white; background: var(--color-primary); }


        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å (–ú–æ–±–∏–ª—å–Ω—ã–π –≤–∏–¥) */
        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                min-height: 100vh;
                border-radius: 0;
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                min-width: 100%;
                height: 100%; 
                position: absolute; /* –î–µ–ª–∞–µ–º —Å–∞–π–¥–±–∞—Ä –º–æ–¥–∞–ª—å–Ω—ã–º */
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease-out;
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #chatWindow {
                width: 100%;
            }
            .chat-header {
                display: flex;
                align-items: center;
            }
            #menuToggle { 
                display: block; 
                margin-right: 15px; 
                font-size: 1.5em;
                color: var(--color-secondary);
                cursor: pointer;
            }
        }
    </style>
</head>
<body>
    
    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê/–†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
    <div id="loginScreen">
        <div id="loginBox">
            <h2><i class="fab fa-telegram-plane"></i> –ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
            <p>–î–ª—è –Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google:</p>
            <button id="googleSignInBtn" onclick="signInWithGoogle()"><i class="fab fa-google"></i> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
            
            <div id="usernameSetup">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫ –≤ TG):</p>
                <input type="text" id="usernameSetupInput" placeholder="@username (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)">
                <button onclick="saveUsername()"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <div id="usernameError" style="color: var(--color-danger); margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† –ú–ï–°–°–ï–ù–î–ñ–ï–†–ê -->
    <div class="app-container" id="chatApp" style="display:none;">
        
        <!-- –õ–ï–í–´–ô –°–ê–ô–î–ë–ê–† (–°–∫—Ä—ã—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, –ø–æ–∫–∞ –Ω–µ –Ω–∞–∂–∞—Ç) -->
        <div id="sidebar">
            <div id="searchBox">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ @username..." oninput="searchUsers(this.value)">
            </div>
            <div id="contactList">
                <div class="contact-item" id="globalChatLink" onclick="startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç')">
                    <div class="contact-item-info">
                        <div class="contact-item-name">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</div>
                        <div class="contact-item-username">@public</div>
                    </div>
                </div>
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã -->
            </div>
             <div class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏ (<span id="myUsernameDisplay"></span>)
            </div>
        </div>

        <!-- –ü–†–ê–í–û–ï –û–ö–ù–û –ß–ê–¢–ê -->
        <div id="chatWindow">
            <div class="chat-header" id="chatHeader">
                <i id="menuToggle" class="fas fa-bars" onclick="toggleSidebar()"></i>
                <span>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
            </div>
            <div id="messageArea">
                <div class="message msg-other">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–∞—Ç—å—Å—è.</div>
            </div>
            
            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –º–µ–¥–∏–∞ -->
            <div class="chat-input" id="chatInputArea" style="display:none;">
                
                <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ (—Å–∫—Ä—ã—Ç—ã–π input) -->
                <button onclick="document.getElementById('fileInput').click()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">

                <!-- UI –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø–∏—Å–∏) -->
                <div id="recorderUI">
                    <i class="fas fa-microphone-alt"></i> 
                    <span id="recorderTimer">00:00</span>
                    <button id="cancelRecordBtn" onclick="stopRecording(false)" title="–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å">
                        <i class="fas fa-times"></i>
                    </button>
                    <button id="sendVoiceBtn" onclick="stopRecording(true)" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å">
                        <i class="fas fa-check"></i>
                    </button>
                </div>

                <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø–∏—Å–∏) -->
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleKeyPress(event)">
                
                <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ / –ú–∏–∫—Ä–æ—Ñ–æ–Ω (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å) -->
                <button id="sendTextBtn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="micToggleBtn" onclick="toggleRecording()" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ===========================================
        // üîë –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–ê–®–ò –ö–õ–Æ–ß–ò)
        // ===========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBFBZLS7W9uBqpNItQUeCSYJ2IRG7G5UiA",
          authDomain: "chat-ca735.firebaseapp.com",
          databaseURL: "https://chat-ca735-default-rtdb.firebaseio.com",
          projectId: "chat-ca735",
          storageBucket: "chat-ca735.firebasestorage.app",
          messagingSenderId: "407446630782",
          appId: "1:407446630782:web:5d9b66c3e8ff051bebc32f",
          measurementId: "G-DJ4K3BB9ZE"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Storage

        // ===========================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ===========================================
        let currentUser = null; 
        let myUsername = null; 
        let activeChatId = null; 
        let unsubscribeFromChat = null; 
        const contactList = document.getElementById('contactList');
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingInterval = null;
        let recordingStartTime = 0;


        // ===========================================
        // üîê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
        // ===========================================

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    handleAuthSuccess(result.user);
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ Google Auth:", error);
                    showCustomAlert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
                });
        }

        function handleAuthSuccess(user) {
            currentUser = user;
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists && doc.data().username) {
                        myUsername = doc.data().username;
                        initializeChatApp();
                    } else {
                        document.getElementById('googleSignInBtn').style.display = 'none';
                        document.getElementById('usernameSetup').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
                });
        }
        
        function saveUsername() {
            const usernameInput = document.getElementById('usernameSetupInput');
            const errorDiv = document.getElementById('usernameError');
            let usernameValue = usernameInput.value.trim().toLowerCase().replace('@', '');
            
            if (!/^[a-z0-9_]{3,}$/.test(usernameValue)) {
                errorDiv.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –õ–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, "_", –æ—Ç 3 —Å–∏–º–≤–æ–ª–æ–≤.';
                return;
            }
            
            errorDiv.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...';

            db.collection('users').where('username', '==', usernameValue).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        return db.collection('users').doc(currentUser.uid).set({
                            uid: currentUser.uid,
                            username: usernameValue,
                            displayName: currentUser.displayName,
                            email: currentUser.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        throw new Error('–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.');
                    }
                })
                .then(() => {
                    myUsername = usernameValue;
                    errorDiv.textContent = '–£—Å–ø–µ—à–Ω–æ! –í—Ö–æ–¥...';
                    initializeChatApp();
                })
                .catch(error => {
                    errorDiv.textContent = error.message;
                    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏:", error);
                });
        }
        
        function logout() {
             auth.signOut().then(() => {
                window.location.reload();
             });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                handleAuthSuccess(user);
            } else {
                document.getElementById('chatApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('googleSignInBtn').style.display = 'block';
                document.getElementById('usernameSetup').style.display = 'none';
            }
        });

        // ===========================================
        // üíª UI / –ù–ê–í–ò–ì–ê–¶–ò–Ø
        // ===========================================
        
        function initializeChatApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            document.getElementById('myUsernameDisplay').textContent = `@${myUsername}`;
            
            const globalChatLink = document.getElementById('globalChatLink');
            startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç', globalChatLink); 
        }
        
        function startNewChat(targetUidOrTag, targetUsername, element = null) {
            document.getElementById('messageArea').innerHTML = '';
            
            if (unsubscribeFromChat) {
                 unsubscribeFromChat();
            }

            activeChatId = targetUidOrTag;
            
            document.getElementById('chatHeader').innerHTML = `
                <i id="menuToggle" class="fas fa-bars" onclick="toggleSidebar()"></i>
                <span>–ß–∞—Ç —Å @${targetUsername}</span>
            `;
            document.getElementById('chatInputArea').style.display = 'flex';
            document.getElementById('messageInput').focus();

            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º: –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }


            listenForChatMessages(targetUidOrTag);
        }

        function toggleSidebar() {
             const sidebar = document.getElementById('sidebar');
             sidebar.classList.toggle('open');
        }


        // ===========================================
        // üîç –ü–û–ò–°–ö
        // ===========================================
        
        function searchUsers(query) {
             contactList.querySelectorAll('.search-result').forEach(el => el.remove());

             const cleanQuery = query.toLowerCase().replace(/[@\s]/g, '');
             
             if (cleanQuery.length < 2) return;

             db.collection('users')
                .where('username', '>=', cleanQuery)
                .where('username', '<=', cleanQuery + '\uf8ff') 
                .limit(5)
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        
                        if (user.uid === currentUser.uid) return; 
                        
                        const item = document.createElement('div');
                        item.className = 'contact-item search-result';
                        item.onclick = (e) => {
                            startNewChat(user.uid, user.username, e.currentTarget);
                        };
                        item.innerHTML = `
                            <div class="contact-item-info">
                                <div class="contact-item-name">${user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                                <div class="contact-item-username">@${user.username}</div>
                            </div>
                        `;
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π –≤—ã—Ö–æ–¥–∞
                        contactList.appendChild(item);
                    });
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", error);
                });
        }

        // ===========================================
        // üíæ –•–†–ê–ù–ò–õ–ò–©–ï FIREBASE STORAGE (–§–ê–ô–õ–´ –ò –ì–û–õ–û–°)
        // ===========================================

        function uploadFileToStorage(file, path) {
             return new Promise((resolve, reject) => {
                 const storageRef = storage.ref(`${path}/${file.name}_${Date.now()}`);
                 const uploadTask = storageRef.put(file);

                 uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, 
                     // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è UI)
                     snapshot => {
                         const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                         console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ ${progress.toFixed(0)}%`);
                         // –¢—É—Ç –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                     },
                     // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                     error => {
                         console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Storage:", error);
                         reject(error);
                     },
                     // –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                     () => {
                         uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
                             resolve(downloadURL);
                         });
                     }
                 );
             });
        }

        // ===========================================
        // üó£Ô∏è –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø
        // ===========================================

        function updateTimer() {
            const timeElapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = String(Math.floor(timeElapsed / 60)).padStart(2, '0');
            const seconds = String(timeElapsed % 60).padStart(2, '0');
            document.getElementById('recorderTimer').textContent = `${minutes}:${seconds}`;
        }

        async function toggleRecording() {
            if (isRecording) {
                // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –Ω–∞–∂–∞—Ç–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–µ
                stopRecording(true); 
            } else {
                startRecording();
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { 'type' : 'audio/ogg; codecs=opus' });
                    // –û—Ç–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                    stream.getTracks().forEach(track => track.stop()); 
                    
                    if (isRecording) { // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –æ—Ç–º–µ–Ω–∞
                       uploadAndSendAudio(audioBlob);
                    }
                    
                    isRecording = false;
                    clearInterval(recordingInterval);
                    document.getElementById('recorderUI').classList.remove('active');
                    document.getElementById('messageInput').style.display = 'block';
                    document.getElementById('sendTextBtn').style.display = 'block';
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                recordingInterval = setInterval(updateTimer, 1000);

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                document.getElementById('recorderUI').classList.add('active');
                document.getElementById('messageInput').style.display = 'none';
                document.getElementById('sendTextBtn').style.display = 'none';
                document.getElementById('recorderTimer').textContent = '00:00';

            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ", err);
                showCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.");
            }
        }

        function stopRecording(shouldSend) {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                isRecording = shouldSend; // –§–ª–∞–≥ –¥–ª—è onstop
                mediaRecorder.stop();
            }
            // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–∞
            clearInterval(recordingInterval);
        }
        
        async function uploadAndSendAudio(audioBlob) {
             showCustomAlert("–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...");
             try {
                const downloadURL = await uploadFileToStorage(audioBlob, 'voice_messages');
                sendMessage(downloadURL, 'audio', '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
             } catch (error) {
                showCustomAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.");
             }
        }

        // ===========================================
        // üñºÔ∏è –û–¢–ü–†–ê–í–ö–ê –§–ê–ô–õ–û–í
        // ===========================================
        
        async function handleFileUpload(event) {
             const file = event.target.files[0];
             if (!file) return;

             showCustomAlert("–§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...");

             try {
                const fileType = file.type.startsWith('image/') ? 'image' : 
                                 file.type.startsWith('audio/') ? 'audio' : 'file';

                const path = fileType === 'image' ? 'images' : 'documents';
                
                const downloadURL = await uploadFileToStorage(file, path);
                sendMessage(downloadURL, fileType, file.name);

             } catch (error) {
                showCustomAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.");
             } finally {
                // –°–±—Ä–æ—Å –ø–æ–ª—è –≤–≤–æ–¥–∞, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞
                document.getElementById('fileInput').value = '';
             }
        }

        // ===========================================
        // üì§ –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô (–û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        // ===========================================

        function getChatCollectionRef(chatId) {
             if (chatId !== 'public_chat') {
                 const uids = [currentUser.uid, chatId].sort();
                 chatId = uids[0] + "_" + uids[1];
             }
             return db.collection('chats').doc(chatId).collection('messages');
        }

        function listenForChatMessages(chatId) {
             const messagesRef = getChatCollectionRef(chatId);
             
             unsubscribeFromChat = messagesRef.orderBy('timestamp').limit(50).onSnapshot(snapshot => {
                 document.getElementById('messageArea').innerHTML = ''; 
                 
                 snapshot.forEach(doc => {
                     appendMessageToUI(doc.data());
                 });
                 
                 document.getElementById('messageArea').scrollTop = document.getElementById('messageArea').scrollHeight;
             }, error => {
                 console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —á–∞—Ç–∞:", error);
             });
        }

        function sendMessage(mediaUrl = null, mediaType = null, mediaName = null) {
            if (!activeChatId) return;

            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();

            if (messageText === "" && !mediaUrl) return;

            const message = {
                sender: myUsername,
                text: messageText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                // –ú–µ–¥–∏–∞-–¥–∞–Ω–Ω—ã–µ
                mediaUrl: mediaUrl,
                mediaType: mediaType,
                mediaName: mediaName
            };

            const messagesRef = getChatCollectionRef(activeChatId);
            
            messagesRef.add(message)
                .then(() => {
                    input.value = ''; 
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ", error);
                    showCustomAlert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message);
                });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ===========================================
        // üé® UI –†–ï–ù–î–ï–†–ò–ù–ì
        // ===========================================

        function appendMessageToUI(message) {
            const messageArea = document.getElementById('messageArea');
            const msgElement = document.createElement('div');
            
            const isUser = message.sender === myUsername;
            msgElement.className = `message ${isUser ? 'msg-user' : 'msg-other'}`;

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ –ø—É–±–ª–∏—á–Ω–æ–º —á–∞—Ç–µ)
            if (!isUser && activeChatId === 'public_chat') {
                 const senderSpan = document.createElement('div');
                 senderSpan.className = 'msg-sender';
                 senderSpan.textContent = `@${message.sender}`;
                 msgElement.appendChild(senderSpan);
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–µ–¥–∏–∞
            if (message.mediaUrl) {
                if (message.mediaType === 'image') {
                    const img = document.createElement('img');
                    img.src = message.mediaUrl;
                    img.alt = message.mediaName || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                    msgElement.appendChild(img);
                } else if (message.mediaType === 'audio') {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = message.mediaUrl;
                    msgElement.appendChild(audio);
                } else {
                    // –§–∞–π–ª—ã
                    const fileLink = document.createElement('a');
                    fileLink.href = message.mediaUrl;
                    fileLink.target = '_blank';
                    fileLink.className = 'file-link';
                    fileLink.innerHTML = `<i class="fas fa-file-download"></i> ${message.mediaName || '–§–∞–π–ª'}`;
                    msgElement.appendChild(fileLink);
                }
            }
            
            // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (message.text && message.text.trim().length > 0) {
                 const textNode = document.createElement('div');
                 textNode.textContent = message.text;
                 msgElement.appendChild(textNode);
            }
            
            // –í—Ä–µ–º—è
            let timeStr = '...';
            if (message.timestamp && message.timestamp.toDate) {
                 timeStr = message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            const timeSpan = document.createElement('span');
            timeSpan.className = 'msg-time';
            timeSpan.textContent = timeStr;
            msgElement.appendChild(timeSpan);

            messageArea.appendChild(msgElement);
        }
        
        // ===========================================
        // ‚ö†Ô∏è –ö–ê–°–¢–û–ú–ù–´–ô ALERT (–í–º–µ—Å—Ç–æ window.alert)
        // ===========================================

        function showCustomAlert(message) {
             // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–æ—Å—Ç –∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.
             // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º—ã –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å –∏ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
             console.warn("–í–Ω–∏–º–∞–Ω–∏–µ:", message);
             const header = document.getElementById('chatHeader').querySelector('span');
             if (header) {
                 const originalText = header.textContent;
                 header.textContent = `‚ö†Ô∏è ${message}`;
                 setTimeout(() => {
                     header.textContent = originalText;
                 }, 3000);
             }
        }
    </script>
</body>
</html>

