<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å Google Auth –∏ –ü–æ–∏—Å–∫–æ–º</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ë–ò–ë–õ–ò–û–¢–ï–ö FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-container: #1c1c1e;
            --color-primary: #4cd964; /* Telegram green */
            --color-secondary: #007aff;
            --color-text: #f5f5f7;
            --color-input: #4c4c4e;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-dark); 
            color: var(--color-text); 
            padding: 0; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-size: 14px;
        }
        .app-container { 
            width: 100%; 
            max-width: 800px; 
            height: 90vh; 
            background: var(--bg-container); 
            border-radius: 12px; 
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5); 
            display: flex; 
            overflow: hidden; 
        }
        
        /* 1. –°–¢–†–ê–ù–ò–¶–ê –í–•–û–î–ê */
        #loginScreen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg-dark); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 100; 
        }
        #loginBox { 
            background: #2c2c2e; 
            padding: 40px; 
            border-radius: 10px; 
            text-align: center; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
        }
        #googleSignInBtn { 
            padding: 12px 25px; 
            background: #db4437; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.1em; 
            transition: background 0.2s;
        }
        #googleSignInBtn:hover { background: #c33d31; }

        #usernameSetup { margin-top: 20px; display: none; }
        #usernameSetup input { 
            padding: 10px; 
            margin: 10px 0; 
            width: 250px; 
            border-radius: 5px; 
            border: 1px solid #4c4c4e; 
            background: var(--color-input); 
            color: white; 
        }
        #usernameSetup button { 
            background: var(--color-primary); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer;
        }


        /* 2. –õ–ï–í–´–ô –°–ê–ô–î–ë–ê–† (–°–ü–ò–°–û–ö –ß–ê–¢–û–í) */
        #sidebar { 
            width: 35%; 
            max-width: 300px; 
            background: #2c2c2e; 
            border-right: 1px solid #3c3c3e; 
            display: flex; 
            flex-direction: column; 
        }
        #searchBox { padding: 10px; border-bottom: 1px solid #3c3c3e; }
        #searchBox input { 
            width: 100%; 
            padding: 10px; 
            border-radius: 20px; 
            border: none; 
            background: var(--color-input); 
            color: white; 
            font-size: 1em;
        }
        #contactList { overflow-y: auto; flex-grow: 1; }
        .contact-item { 
            padding: 12px 15px; 
            cursor: pointer; 
            border-bottom: 1px solid #3c3c3e; 
            transition: background 0.2s; 
            display: flex; 
            align-items: center; 
        }
        .contact-item:hover, .contact-item.active { background: #3c3c3e; }
        .contact-item-info { flex-grow: 1; }
        .contact-item-name { font-weight: bold; font-size: 1.1em; }
        .contact-item-username { font-size: 0.9em; color: #8e8e93; }
        .logout-btn { 
            padding: 10px; 
            text-align: center; 
            border-top: 1px solid #3c3c3e; 
            cursor: pointer; 
            color: #db4437; 
            font-size: 1.1em;
        }


        /* 3. –ü–†–ê–í–´–ô –ß–ê–¢ (–û–°–ù–û–í–ù–û–ï –û–ö–ù–û) */
        #chatWindow { width: 65%; display: flex; flex-direction: column; }
        .chat-header { 
            padding: 15px; 
            background: #2c2c2e; 
            border-bottom: 1px solid #3c3c3e; 
            color: white; 
            text-align: left; 
            font-size: 1.2em; 
            font-weight: bold; 
        }
        #messageArea { 
            flex-grow: 1; 
            padding: 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .message { 
            padding: 10px 15px; 
            border-radius: 15px; 
            max-width: 80%; 
            line-height: 1.4; 
            word-wrap: break-word; /* –í–∞–∂–Ω–æ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
        }
        .msg-user { 
            background: var(--color-primary); 
            color: white; 
            align-self: flex-end; 
            border-bottom-right-radius: 2px; 
        }
        .msg-other { 
            background: #3c3c3e; 
            color: white; 
            align-self: flex-start; 
            border-bottom-left-radius: 2px; 
        }
        .msg-time { 
            font-size: 0.75em; 
            opacity: 0.7; 
            margin-left: 10px; 
            display: inline-block;
        }
        .msg-sender { font-weight: bold; font-size: 0.9em; margin-bottom: 2px; color: #b1b1b1;}
        .chat-input { display: flex; padding: 15px; background: #2c2c2e; border-top: 1px solid #3c3c3e; }
        .chat-input input { 
            flex-grow: 1; 
            padding: 10px; 
            border: none; 
            border-radius: 20px; 
            background: var(--color-input); 
            color: white; 
            margin-right: 10px; 
        }
        .chat-input button { 
            background: var(--color-primary); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            cursor: pointer;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 600px) {
            .app-container {
                height: 100vh;
                border-radius: 0;
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                max-width: none;
                height: 50px; /* –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–æ–∏—Å–∫ */
                overflow: hidden;
                border-right: none;
                border-bottom: 1px solid #3c3c3e;
            }
            #chatWindow {
                width: 100%;
            }
            /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–∏—Å–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã */
            #contactList { display: none; }
            #searchBox { padding: 10px 15px; border-bottom: none; }
            .logout-btn { display: none; }
        }
    </style>
</head>
<body>
    
    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê/–†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
    <div id="loginScreen">
        <div id="loginBox">
            <h2><i class="fab fa-telegram-plane"></i> –ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
            <p>–î–ª—è –Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google:</p>
            <button id="googleSignInBtn" onclick="signInWithGoogle()"><i class="fab fa-google"></i> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
            
            <div id="usernameSetup">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫ –≤ TG):</p>
                <input type="text" id="usernameSetupInput" placeholder="@username (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)">
                <button onclick="saveUsername()"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <div id="usernameError" style="color: #db4437; margin-top: 5px;"></div>
            </div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† –ú–ï–°–°–ï–ù–î–ñ–ï–†–ê -->
    <div class="app-container" id="chatApp" style="display:none;">
        
        <!-- –õ–ï–í–´–ô –°–ê–ô–î–ë–ê–† -->
        <div id="sidebar">
            <div id="searchBox">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ @username..." oninput="searchUsers(this.value)">
            </div>
            <div id="contactList">
                <div class="contact-item" id="globalChatLink" onclick="startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç')">
                    <div class="contact-item-info">
                        <div class="contact-item-name">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</div>
                        <div class="contact-item-username">@public</div>
                    </div>
                </div>
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã -->
            </div>
             <div class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏ (<span id="myUsernameDisplay"></span>)
            </div>
        </div>

        <!-- –ü–†–ê–í–û–ï –û–ö–ù–û –ß–ê–¢–ê -->
        <div id="chatWindow">
            <div class="chat-header" id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <div id="messageArea">
                <div class="message msg-other">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–∞—Ç—å—Å—è.</div>
            </div>
            <div class="chat-input" id="chatInputArea" style="display:none;">
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleKeyPress(event)">
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    
    <script>
        // ===========================================
        // üîë –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–ê–®–ò –ö–õ–Æ–ß–ò)
        // ===========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBFBZLS7W9uBqpNItQUeCSYJ2IRG7G5UiA",
          authDomain: "chat-ca735.firebaseapp.com",
          databaseURL: "https://chat-ca735-default-rtdb.firebaseio.com",
          projectId: "chat-ca735",
          storageBucket: "chat-ca735.firebasestorage.app",
          messagingSenderId: "407446630782",
          appId: "1:407446630782:web:5d9b66c3e8ff051bebc32f",
          measurementId: "G-DJ4K3BB9ZE"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ===========================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ===========================================
        let currentUser = null; 
        let myUsername = null; 
        let activeChatId = null; 
        let unsubscribeFromChat = null; 
        const contactList = document.getElementById('contactList');


        // ===========================================
        // üîê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø (Google Sign-In)
        // ===========================================

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    handleAuthSuccess(result.user);
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ Google Auth:", error);
                    showCustomAlert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
                });
        }

        function handleAuthSuccess(user) {
            currentUser = user;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ @username
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists && doc.data().username) {
                        myUsername = doc.data().username;
                        initializeChatApp();
                    } else {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π, –ø—Ä–æ—Å–∏–º –≤—ã–±—Ä–∞—Ç—å @username
                        document.getElementById('googleSignInBtn').style.display = 'none';
                        document.getElementById('usernameSetup').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
                });
        }
        
        function saveUsername() {
            const usernameInput = document.getElementById('usernameSetupInput');
            const errorDiv = document.getElementById('usernameError');
            let usernameValue = usernameInput.value.trim().toLowerCase();
            
            if (usernameValue.startsWith('@')) {
                 usernameValue = usernameValue.substring(1);
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞: —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ _, 3+ —Å–∏–º–≤–æ–ª–∞
            if (!/^[a-z0-9_]{3,}$/.test(usernameValue)) {
                errorDiv.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã –∏ "_", –æ—Ç 3 —Å–∏–º–≤–æ–ª–æ–≤.';
                return;
            }
            
            errorDiv.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...';

            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ @username
            db.collection('users').where('username', '==', usernameValue).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        // 2. –ò–º—è —Å–≤–æ–±–æ–¥–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                        return db.collection('users').doc(currentUser.uid).set({
                            uid: currentUser.uid,
                            username: usernameValue,
                            displayName: currentUser.displayName,
                            email: currentUser.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        throw new Error('–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.');
                    }
                })
                .then(() => {
                    myUsername = usernameValue;
                    errorDiv.textContent = '–£—Å–ø–µ—à–Ω–æ! –í—Ö–æ–¥...';
                    initializeChatApp();
                })
                .catch(error => {
                    errorDiv.textContent = error.message;
                    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏:", error);
                });
        }
        
        function logout() {
             auth.signOut().then(() => {
                window.location.reload();
             });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Ö–æ–¥–∞
        auth.onAuthStateChanged(user => {
            if (user) {
                handleAuthSuccess(user);
            } else {
                document.getElementById('chatApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('googleSignInBtn').style.display = 'block';
                document.getElementById('usernameSetup').style.display = 'none';
            }
        });

        // ===========================================
        // üîç –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
        // ===========================================
        
        function searchUsers(query) {
             // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç
             contactList.querySelectorAll('.search-result').forEach(el => el.remove());

             const cleanQuery = query.toLowerCase().replace(/[@\s]/g, '');
             
             if (cleanQuery.length < 2) return;

             // –ó–∞–ø—Ä–æ—Å Firestore: –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å...)
             db.collection('users')
                .where('username', '>=', cleanQuery)
                .where('username', '<=', cleanQuery + '\uf8ff') 
                .limit(5)
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        
                        if (user.uid === currentUser.uid) return; // –ò—Å–∫–ª—é—á–∞–µ–º —Å–µ–±—è
                        
                        const item = document.createElement('div');
                        item.className = 'contact-item search-result';
                        item.onclick = (e) => {
                            // –ü–µ—Ä–µ–¥–∞–µ–º UID (–¥–ª—è —á–∞—Ç–∞) –∏ username (–¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞)
                            startNewChat(user.uid, user.username, e.currentTarget);
                        };
                        item.innerHTML = `
                            <div class="contact-item-info">
                                <div class="contact-item-name">${user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                                <div class="contact-item-username">@${user.username}</div>
                            </div>
                        `;
                        contactList.appendChild(item);
                    });
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", error);
                });
        }

        // ===========================================
        // üí¨ –õ–û–ì–ò–ö–ê –ß–ê–¢–ê
        // ===========================================

        function initializeChatApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            document.getElementById('myUsernameDisplay').textContent = `@${myUsername}`;
            
            // –ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —á–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            startNewChat('public_chat', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç', document.getElementById('globalChatLink')); 
        }
        
        function startNewChat(targetUidOrTag, targetUsername, element = null) {
            document.getElementById('messageArea').innerHTML = '';
            
            if (unsubscribeFromChat) {
                 unsubscribeFromChat(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ —á–∞—Ç–∞
            }

            activeChatId = targetUidOrTag;
            
            document.getElementById('chatHeader').textContent = `–ß–∞—Ç —Å @${targetUsername}`;
            document.getElementById('chatInputArea').style.display = 'flex';
            document.getElementById('messageInput').focus();

            // –í—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }


            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
            listenForChatMessages(targetUidOrTag);
        }

        function getChatCollectionRef(chatId) {
             // –î–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Ñ–æ—Ä–º–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —á–∞—Ç–∞ –ø—É—Ç–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ UID
             if (chatId !== 'public_chat') {
                 const uids = [currentUser.uid, chatId].sort();
                 chatId = uids[0] + "_" + uids[1];
             }
             return db.collection('chats').doc(chatId).collection('messages');
        }

        function listenForChatMessages(chatId) {
             const messagesRef = getChatCollectionRef(chatId);
             
             // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏
             unsubscribeFromChat = messagesRef.orderBy('timestamp').limit(50).onSnapshot(snapshot => {
                 document.getElementById('messageArea').innerHTML = ''; 
                 
                 snapshot.forEach(doc => {
                     appendMessageToUI(doc.data());
                 });
                 
                 // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                 document.getElementById('messageArea').scrollTop = document.getElementById('messageArea').scrollHeight;
             }, error => {
                 console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —á–∞—Ç–∞:", error);
             });
        }

        function sendMessage() {
            if (!activeChatId) return;

            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();

            if (messageText === "") return;

            const message = {
                sender: myUsername,
                text: messageText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            const messagesRef = getChatCollectionRef(activeChatId);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∞–∑—É
            messagesRef.add(message)
                .then(() => {
                    input.value = ''; 
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ", error);
                    showCustomAlert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message);
                });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ===========================================
        // UI –†–ï–ù–î–ï–†–ò–ù–ì
        // ===========================================

        function appendMessageToUI(message) {
            const messageArea = document.getElementById('messageArea');
            const msgElement = document.createElement('div');
            
            const isUser = message.sender === myUsername;
            msgElement.className = `message ${isUser ? 'msg-user' : 'msg-other'}`;

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
            let timeStr = '';
            if (message.timestamp && message.timestamp.toDate) {
                 timeStr = message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                 timeStr = '...'; 
            }


            if (!isUser && activeChatId === 'public_chat') {
                 // –í –≥–ª–æ–±–∞–ª—å–Ω–æ–º —á–∞—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                 const senderSpan = document.createElement('div');
                 senderSpan.className = 'msg-sender';
                 senderSpan.textContent = `@${message.sender}`;
                 msgElement.appendChild(senderSpan);
            }
            
            const textContent = document.createTextNode(message.text);
            msgElement.appendChild(textContent);

            const timeSpan = document.createElement('span');
            timeSpan.className = 'msg-time';
            timeSpan.textContent = timeStr;
            msgElement.appendChild(timeSpan);

            messageArea.appendChild(msgElement);
        }
        
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è alert()
        function showCustomAlert(message) {
            console.warn("–í–Ω–∏–º–∞–Ω–∏–µ:", message);
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞—à–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –º–æ–¥–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
            // –î–ª—è —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Å–æ–ª—å.
        }
    </script>
</body>
</html>

